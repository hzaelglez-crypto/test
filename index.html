<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TaktLab – Cycle Time & Capacity Analyzer</title>

<style>
  :root{
    --bg-main:#07152b;
    --bg-card:#0b1f3a;
    --bg-card-soft:#0f2544;
    --accent-green:#00c853;
    --accent-amber:#ffb300;
    --accent-red:#ff1744;
    --accent-blue:#29b6f6;
    --accent-grey:#cfd8dc;
    --text-main:#ffffff;
    --text-soft:#c5cae9;
    --text-muted:#90a4ae;
    --border-soft:#1c3357;
    --btn-green:#00c853;
    --btn-orange:#ff9100;
    --btn-grey:#455a64;
    --badge-green:#004d40;
    --badge-red:#b71c1c;
    --badge-amber:#ff8f00;
  }

  *{box-sizing:border-box;}

  body{
    margin:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:linear-gradient(180deg,#020b1a 0%,#07152b 40%,#020b1a 100%);
    color:var(--text-main);
  }

  .page{
    max-width:1100px;
    margin:0 auto;
    padding:10px 10px 34px; /* compact */
  }

  .sticky-timer-bar{
    position:sticky;
    top:0;
    z-index:100;
    background:linear-gradient(180deg,#020b1a 0%,#07152b 90%);
    padding:6px 0 8px; /* compact */
  }

  .top-row{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:6px; /* compact */
  }

  .logo-circle{
    width:38px;height:38px;border-radius:50%;
    border:2px solid var(--accent-grey);
    display:flex;align-items:center;justify-content:center;
  }
  .logo-gear{
    width:22px;height:22px;border-radius:50%;
    border:2px solid var(--accent-grey);
    position:relative;
  }
  .logo-gear::before{
    content:"";
    position:absolute;
    inset:4px;
    border-radius:50%;
    border:2px solid var(--accent-green);
    border-right-color:transparent;
    border-bottom-color:transparent;
    transform-origin:50% 50%;
  }
  .logo-gear.spinning::before{ animation:logo-spin 2s linear infinite; }
  @keyframes logo-spin{ from{transform:rotate(0deg);} to{transform:rotate(360deg);} }

  .title-block{display:flex;flex-direction:column;gap:2px;}
  .title-main{font-size:1.2rem;font-weight:700;letter-spacing:.03em;}
  .title-sub{font-size:.72rem;color:var(--text-soft);}

  .lang-switch{margin-left:auto;display:flex;align-items:center;gap:4px;}
  .lang-btn{
    border-radius:999px;border:1px solid var(--border-soft);
    background:rgba(2,11,26,.6);color:var(--text-soft);
    font-size:.7rem;padding:4px 8px;cursor:pointer;min-width:34px;
  }
  .lang-btn.active{background:var(--accent-blue);color:#fff;border-color:var(--accent-blue);font-weight:600;}

  .timer-card{
    background:var(--bg-card);
    border-radius:18px;
    border:1px solid var(--border-soft);
    padding:6px 10px 10px;
    box-shadow:0 8px 18px rgba(0,0,0,.45);
  }

  .timer-display{
    text-align:center;
    font-size:2.8rem;
    font-weight:600;
    letter-spacing:.08em;
    padding:4px 4px 6px; /* compact */
  }

  .info-stack{ display:flex; flex-direction:column; gap:6px; margin:0 0 8px; }
  .info-line{
    font-size:.78rem;margin:0;padding:6px 10px;
    border-radius:12px;border:1px solid transparent;
    line-height:1.25;
  }
  .sample-neutral{background:rgba(255,255,255,.03);border-color:rgba(255,255,255,.08);color:var(--text-soft);}
  .sample-good{background:rgba(0,200,83,.15);border-color:rgba(0,200,83,.7);color:#c8e6c9;}
  .sample-warn{background:rgba(255,193,7,.14);border-color:rgba(255,193,7,.8);color:#ffe082;}
  .sample-bad{background:rgba(244,67,54,.16);border-color:rgba(244,67,54,.9);color:#ffab91;}

  .btn-row-main{display:flex;gap:10px;margin-bottom:2px;}
  .btn{
    border:none;border-radius:16px;padding:10px 12px;
    font-size:.9rem;font-weight:600;cursor:pointer;color:#fff;
    box-shadow:0 4px 10px rgba(0,0,0,.4);flex:1;
    transition:transform .04s ease, box-shadow .04s ease, background .15s;
    touch-action:manipulation;
  }
  .btn:active{transform:translateY(1px);box-shadow:0 1px 4px rgba(0,0,0,.5);}
  .btn-start{background:var(--btn-green);}
  .btn-lap{background:var(--btn-orange);}

  .flash{animation:flash-bg .12s ease-out;}
  @keyframes flash-bg{ from{background:rgba(255,255,255,.18);} to{background:transparent;} }

  .content-section{margin-top:8px;} /* compact */

  .section-card{
    background:var(--bg-card);
    border-radius:18px;
    border:1px solid var(--border-soft);
    padding:8px 10px 10px; /* compact */
    margin-bottom:10px;
  }
  .section-title{font-size:1.0rem;font-weight:700;margin-bottom:6px;} /* compact */

  .mode-row{
    display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;
    font-size:.78rem;color:var(--text-soft);
  }
  .mode-row select,.mode-row input{
    background:#020b1a;border-radius:8px;border:1px solid var(--border-soft);
    padding:4px 8px;color:var(--text-soft);font-size:.78rem;min-width:70px;
  }
  .mode-row input[type="number"]{width:78px;}

  table{width:100%;border-collapse:collapse;font-size:.72rem;} /* compact */
  th,td{
    padding:3px 5px;text-align:right; /* compact */
    border-bottom:1px solid rgba(255,255,255,.04);
    white-space:nowrap;
    vertical-align:middle;
  }
  th:first-child,td:first-child{text-align:left;}
  th{
    color:var(--text-soft);font-weight:600;background:rgba(255,255,255,.02);
    position:sticky;top:0;z-index:5;
  }
  tbody tr:nth-child(even){background:rgba(255,255,255,.02);}

  .badge{
    display:inline-block;padding:2px 6px;border-radius:999px;
    font-size:.68rem;border:1px solid transparent;
  }
  .badge-good{background:var(--badge-green);border-color:#00e676;}
  .badge-warn{background:var(--badge-amber);border-color:#ffe082;color:#000;}
  .badge-bad{background:var(--badge-red);border-color:#ff8a80;}

  .btn-row-secondary{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 4px;}
  .btn-small{
    padding:12px 18px;            /* BIGGER */
    border-radius:18px;           /* BIGGER */
    font-size:.95rem;             /* BIGGER */
    font-weight:800;              /* BIGGER */
    flex:0 0 auto;background:var(--bg-card-soft);color:var(--text-soft);
    border:1px solid var(--border-soft);cursor:pointer;box-shadow:0 3px 8px rgba(0,0,0,.35);
  }
  .btn-small-copy{background:var(--accent-blue);border-color:var(--accent-blue);color:#fff;}
  .btn-small-summary{background:var(--accent-amber);border-color:var(--accent-amber);color:#000;}
  .btn-small-manual{background:var(--accent-green);border-color:var(--accent-green);color:#000;}
  .btn-small-reset{background:var(--accent-red);border-color:var(--accent-red);color:#fff;}
  .btn-small-wbadd{background:rgba(255,255,255,.06);color:var(--text-soft);}
  .btn-small-wbclear{background:rgba(255,23,68,.16);border-color:rgba(255,23,68,.6);color:#ff8a80;}

  .subsection-title{margin-top:10px;font-size:.82rem;font-weight:650;color:var(--text-soft);}

  .footer-note{margin-top:10px;font-size:.65rem;color:var(--text-muted);text-align:right;}

  .charts-wrapper{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:10px;
  }
  .chart-card{
    background:var(--bg-card-soft);
    border-radius:14px;
    border:1px solid var(--border-soft);
    padding:8px;
  }
  .chart-title{font-size:.75rem;margin-bottom:4px;color:var(--text-soft);}
  canvas{width:100%;height:180px;background:#020b1a;border-radius:10px;}

  .btn-edit,.btn-del,.btn-relink{
    padding:2px 6px;border-radius:8px;font-size:.7rem;
    border:1px solid rgba(255,255,255,.2);cursor:pointer;background:transparent;
  }
  .btn-edit{color:#81d4fa;}
  .btn-del{color:#ff8a80;}
  .btn-relink{color:#ffe082;}

  /* WB inputs – más compactos */
  .wb-inp, .wb-sel, .wb-chk{
    background:#020b1a;border-radius:8px;border:1px solid var(--border-soft);
    padding:2px 5px;color:var(--text-soft);font-size:.70rem;
  }
  .wb-inp{width:72px;}
  .wb-inp.wide{width:140px;}
  .wb-inp.slim{width:56px;}
  .wb-sel{width:84px;}
  .wb-pill{
    display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.03);font-size:.72rem;color:var(--text-soft);
  }
  .wb-alert{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:8px;}
  .wb-alert .badge{font-size:.72rem;padding:4px 10px;}
  .wb-badge-title{font-size:.72rem;color:var(--text-soft);}
  .wb-mini{font-size:.7rem;color:var(--text-muted);line-height:1.25;margin-top:6px;}
  .wb-sumline{
    display:flex;justify-content:flex-end;gap:10px;align-items:center;
    margin-top:6px;font-size:.72rem;color:var(--text-soft);
  }
  .wb-sumline .badge{font-size:.70rem}

  @media (max-width:600px){
    .timer-display{font-size:2.2rem;}
    .btn-row-main{gap:6px;}
    .btn{font-size:.9rem;border-radius:14px;}
    canvas{height:160px;}
    th,td{font-size:.70rem;}
    .wb-inp{width:66px;}
    .wb-inp.wide{width:120px;}
    .btn-small{padding:12px 16px;font-size:.92rem;}
  }
</style>
</head>

<body>
<div class="page">

  <div class="sticky-timer-bar">
    <div class="top-row">
      <div class="logo-circle"><div class="logo-gear" id="logoGear"></div></div>
      <div class="title-block">
        <div class="title-main">TaktLab</div>
        <div class="title-sub" data-i18n="title.subtitle">Cycle Time &amp; Capacity Analyzer</div>
      </div>
      <div class="lang-switch">
        <button class="lang-btn" data-lang="en">EN</button>
        <button class="lang-btn" data-lang="es">ES</button>
      </div>
    </div>

    <div class="timer-card" id="timerCard">
      <div class="timer-display" id="display">00:00.00</div>

      <div class="info-stack">
        <div class="info-line sample-neutral" id="sampleInfoTop">
          No samples yet for current process. Start capturing laps.
        </div>
      </div>

      <div class="btn-row-main">
        <button class="btn btn-start" id="btnStart" data-i18n="btn.start">Start</button>
        <button class="btn btn-lap" id="btnLap" data-i18n="btn.lap">LAP</button>
      </div>
    </div>
  </div>

  <div class="content-section">

    <div class="section-card">
      <div class="section-title" data-i18n="section.measurementSetup">Measurement Setup</div>

      <div class="mode-row">
        <div>
          <label for="processName" data-i18n="label.process">Process</label><br/>
          <input id="processName" type="text" placeholder="e.g. Op 30-1" data-i18n-placeholder="label.processPlaceholder"/>
        </div>

        <div>
          <label for="mode" data-i18n="label.mode">Mode</label><br/>
          <select id="mode">
            <option value="CT" data-i18n="mode.ct">Cycle Time (CT)</option>
            <option value="MLD" data-i18n="mode.mld">Machine &amp; Load/Unload</option>
          </select>
        </div>

        <div>
          <label for="efficiency" data-i18n="label.efficiency">Efficiency %</label><br/>
          <input id="efficiency" type="number" value="100" min="0" max="100" step="1"/>
        </div>

        <div>
          <label for="contractPcd" data-i18n="label.contractPcd">Contract Cap (pcs/day)</label><br/>
          <input id="contractPcd" type="number" min="0" max="99999" step="1"/>
        </div>

        <div>
          <label for="hoursPerDay" data-i18n="label.hoursPerDay">Hours / Day</label><br/>
          <input id="hoursPerDay" type="number" value="8" min="1" max="24" step=".5"/>
        </div>

        <div>
          <label for="daysPerWeek" data-i18n="label.daysPerWeek">Days / Week</label><br/>
          <input id="daysPerWeek" type="number" value="5" min="1" max="7"/>
        </div>

        <div>
          <label for="capView" data-i18n="label.capView">Capacity View</label><br/>
          <select id="capView">
            <option value="hour" data-i18n="capView.hour">per Hour</option>
            <option value="day" data-i18n="capView.day">per Day</option>
            <option value="week" data-i18n="capView.week">per Week</option>
          </select>
        </div>
      </div>
    </div>

    <!-- NEW: CONTRACT vs CAPACITY SUMMARY -->
    <div class="section-card">
      <div class="section-title" data-i18n="section.contractSummary">Contract vs Capacity Summary</div>

      <div class="info-stack" style="margin-top:4px;">
        <div class="info-line sample-neutral" id="contractSumLine1">—</div>
        <div class="info-line sample-neutral" id="contractSumLine2">—</div>
        <div class="info-line sample-neutral" id="contractSumLine3">—</div>
        <div class="info-line sample-neutral" id="contractSumLine4">—</div>
      </div>

      <div style="font-size:.68rem;color:var(--text-muted);margin:6px 0 0;">
        <span data-i18n="contract.note">Uses current process + your laps (Median/P10/P90) with the Measurement Setup assumptions.</span>
      </div>
    </div>

    <div class="section-card">
      <div class="section-title" data-i18n="section.statsFocus">Stat Focus</div>

      <div class="info-stack" style="margin-top:4px;">
        <div class="info-line sample-neutral" id="sampleInfoFocus">Sample size: —</div>
        <div class="info-line sample-neutral" id="stdInfoFocus">Std dev: —</div>
        <div class="info-line sample-neutral" id="distInfoFocus">Mean vs Median: —</div>
        <div class="info-line sample-neutral" id="contractInfoFocus">No contract loaded</div>
      </div>

      <div style="font-size:.68rem;color:var(--text-muted);margin:6px 0 6px;">
        <span data-i18n="stats.note">Simple language on purpose: few / enough samples, low / high variation, capable / not capable.</span>
      </div>

      <div style="max-height:300px;overflow:auto;">
        <table>
          <thead>
            <tr>
              <th data-i18n="col.process">Process</th>
              <th data-i18n="col.mode">Mode</th>
              <th>N</th>
              <th data-i18n="col.sample">Sample size / Error</th>
              <th>Std</th>
              <th>CV%</th>
              <th>CTmed</th>
              <th>P10</th>
              <th>P90</th>
              <th data-i18n="col.capCurrent">Current @Eff</th>
              <th data-i18n="col.capPotential">Potential @Eff</th>
              <th data-i18n="col.capWorst">Worst @Eff</th>
              <th data-i18n="col.contract">Contract</th>
              <th data-i18n="col.gap">Gap</th>
              <th data-i18n="col.vsContract">% vs</th>
              <th>Cp</th>
              <th>Cpk</th>
              <th data-i18n="col.note">Note</th>
            </tr>
          </thead>
          <tbody id="focusBody"></tbody>
        </table>
      </div>

      <div class="subsection-title" data-i18n="section.wbPlanner">WB – Capacity Planner (by process)</div>

      <div class="btn-row-secondary" style="margin-top:8px;">
        <button class="btn-small btn-small-wbadd" id="btnWbAdd" data-i18n="btn.wbAdd">+ Add Operation</button>
        <button class="btn-small btn-small-wbclear" id="btnWbClear" data-i18n="btn.wbClear">Clear WB</button>
      </div>

      <div style="max-height:320px;overflow:auto;">
        <table id="wbTable">
          <thead>
            <tr>
              <th data-i18n="wb.seq">Seq</th>
              <th data-i18n="wb.enabled">On</th>
              <th data-i18n="wb.operation">Operation</th>
              <th data-i18n="wb.operators">Operators</th>
              <th data-i18n="wb.shifts">Shifts</th>
              <th data-i18n="wb.hours">Hours</th>
              <th data-i18n="wb.machines"># Machines</th>
              <th data-i18n="wb.contract">Contract (pcs/day)</th>

              <th data-i18n="wb.gross">Gross min/day</th>
              <th data-i18n="wb.lunch">Lunch min/day</th>
              <th data-i18n="wb.changeover">Changeover</th>
              <th data-i18n="wb.cleaning">5S/Clean</th>
              <th data-i18n="wb.maint">Maintenance</th>
              <th data-i18n="wb.other">Other</th>

              <th data-i18n="wb.shared">Shared Capacity</th>

              <th data-i18n="wb.udt">Unplanned DT</th>
              <th data-i18n="wb.udtUnit">Unit</th>

              <th data-i18n="wb.net">Net min/day</th>

              <th data-i18n="wb.scrap">Scrap %</th>
              <th data-i18n="wb.yield">Yield</th>

              <th data-i18n="wb.oeeA">A%</th>
              <th data-i18n="wb.oeeP">P%</th>
              <th data-i18n="wb.oeeQ">Q%</th>
              <th data-i18n="wb.oee">OEE%</th>

              <th data-i18n="wb.ctCur">CT Current</th>
              <th data-i18n="wb.ctWst">CT Worst</th>
              <th data-i18n="wb.ctPot">CT Potential</th>

              <th data-i18n="wb.ctCurOee">CT@OEE (Cur)</th>

              <th data-i18n="wb.cap100">Cap 100% (Cur)</th>
              <th data-i18n="wb.capOee">Cap@OEE (Cur)</th>

              <th data-i18n="wb.vsContract">% vs contract</th>
              <th data-i18n="wb.inputReq">Input req. for Contract</th>

              <th data-i18n="wb.actions">Actions</th>
            </tr>
          </thead>
          <tbody id="wbBody"></tbody>
        </table>
      </div>

      <div class="wb-sumline">
        <span data-i18n="wb.opsSum">Operators total:</span>
        <span class="badge badge-warn" id="wbOperatorsSum">0</span>
      </div>

      <div class="wb-alert">
        <span class="wb-badge-title" data-i18n="wb.constraintTitle">Constraint / Next:</span>
        <span class="badge badge-bad" id="wbConstraint">—</span>
        <span class="badge badge-warn" id="wbNextConstraint">—</span>
      </div>
      <div class="wb-mini" id="wbConstraintNote"></div>

      <div class="subsection-title" data-i18n="section.statsDetail">Statistical Detail (per process)</div>
      <div style="max-height:240px;overflow:auto;">
        <table id="statsTable">
          <thead>
            <tr>
              <th data-i18n="col.process">Process</th>
              <th data-i18n="col.mode">Mode</th>
              <th data-i18n="col.n">N</th>
              <th>Mean</th>
              <th>Median</th>
              <th>P10</th>
              <th>P90</th>
              <th>Min</th>
              <th>Max</th>
              <th>Std</th>
              <th>CV%</th>
              <th>Cp</th>
              <th>Cpk</th>
            </tr>
          </thead>
          <tbody id="statsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- MOVED: DATA CONTROLS AFTER STAT FOCUS -->
    <div class="section-card">
      <div class="section-title" data-i18n="section.dataControls">Data Controls</div>
      <div class="btn-row-secondary">
        <button class="btn-small btn-small-copy" id="btnCopyAll" data-i18n="btn.copyAll">Copy All</button>
        <button class="btn-small btn-small-summary" id="btnCopySummary" data-i18n="btn.copySummary">Copy Summary</button>
        <button class="btn-small btn-small-manual" id="btnAddManualLap" data-i18n="btn.addManualLap">Add Manual Lap</button>
        <button class="btn-small btn-small-reset" id="btnReset" data-i18n="btn.reset">Reset</button>
      </div>
    </div>

    <div class="section-card">
      <div class="section-title" data-i18n="section.charts">Charts (selected process)</div>

      <div style="margin-bottom:6px;font-size:.75rem;">
        <label for="chartProcessSelect" data-i18n="label.chartProcessLabel">Process / Mode:</label>
        <select id="chartProcessSelect"></select>
      </div>

      <div class="charts-wrapper">
        <div class="chart-card">
          <div class="chart-title" data-i18n="chart.timeSeriesTitle">Time Series with Mean, Median, ±3σ</div>
          <canvas id="timeSeriesCanvas"></canvas>
        </div>

        <div class="chart-card">
          <div class="chart-title" data-i18n="chart.histTitle">Histogram with Median &amp; Percentiles</div>
          <canvas id="histCanvas"></canvas>
        </div>
      </div>
    </div>

    <div class="section-card">
      <div class="section-title" data-i18n="section.rawData">Raw Time Data</div>
      <div style="max-height:300px;overflow:auto;">
        <table id="dataTable">
          <thead>
            <tr>
              <th data-i18n="col.index">#</th>
              <th data-i18n="col.process">Process</th>
              <th data-i18n="col.mode">Mode</th>
              <th data-i18n="col.status">Status</th>
              <th data-i18n="col.note">Note</th>
              <th data-i18n="col.t1">T1 (s)</th>
              <th data-i18n="col.t2">T2 (s)</th>
              <th data-i18n="col.total">Total (s)</th>
              <th data-i18n="col.edit">Edit</th>
              <th data-i18n="col.del">Del</th>
            </tr>
          </thead>
          <tbody id="dataBody"></tbody>
        </table>
      </div>
    </div>

    <div class="section-card">
      <div class="section-title" data-i18n="section.methodGuide">Method &amp; Guide</div>
      <details style="background:var(--bg-card-soft);border:1px solid var(--border-soft);border-radius:14px;padding:10px;">
        <summary style="cursor:pointer;color:var(--text-soft);font-weight:700;">
          <span data-i18n="method.open">Open</span>
        </summary>
        <div style="margin-top:8px;font-size:.72rem;color:var(--text-soft);line-height:1.35;white-space:pre-wrap;" id="methodGuideText"></div>
      </details>
    </div>

  </div>

  <div class="footer-note" data-i18n="footer.note">
    Created by Roberto González – Contact: hzaelglez@gmail.com
  </div>
</div>

<script>
(function(){
  const display = document.getElementById('display');
  const btnStart = document.getElementById('btnStart');
  const btnLap = document.getElementById('btnLap');
  const timerCard = document.getElementById('timerCard');
  const logoGear = document.getElementById('logoGear');

  const sampleInfoTop = document.getElementById('sampleInfoTop');
  const sampleInfoFocus = document.getElementById('sampleInfoFocus');
  const stdInfoFocus = document.getElementById('stdInfoFocus');
  const distInfoFocus = document.getElementById('distInfoFocus');
  const contractInfoFocus = document.getElementById('contractInfoFocus');

  // Contract Summary lines
  const contractSumLine1 = document.getElementById('contractSumLine1');
  const contractSumLine2 = document.getElementById('contractSumLine2');
  const contractSumLine3 = document.getElementById('contractSumLine3');
  const contractSumLine4 = document.getElementById('contractSumLine4');

  const processInput = document.getElementById('processName');
  const modeSelect   = document.getElementById('mode');
  const effInput     = document.getElementById('efficiency');
  const pcdInput     = document.getElementById('contractPcd');
  const hInput       = document.getElementById('hoursPerDay');
  const dInput       = document.getElementById('daysPerWeek');
  const capViewSel   = document.getElementById('capView');

  const focusBody     = document.getElementById('focusBody');
  const statsBody     = document.getElementById('statsBody');

  const dataBody    = document.getElementById('dataBody');
  const btnCopyAll  = document.getElementById('btnCopyAll');
  const btnCopySum  = document.getElementById('btnCopySummary');
  const btnAddMan   = document.getElementById('btnAddManualLap');
  const btnReset    = document.getElementById('btnReset');

  const chartSelect      = document.getElementById('chartProcessSelect');
  const timeSeriesCanvas = document.getElementById('timeSeriesCanvas');
  const histCanvas       = document.getElementById('histCanvas');

  const langButtons = document.querySelectorAll('.lang-btn');

  const wbBody = document.getElementById('wbBody');
  const btnWbAdd = document.getElementById('btnWbAdd');
  const btnWbClear = document.getElementById('btnWbClear');
  const wbConstraint = document.getElementById('wbConstraint');
  const wbNextConstraint = document.getElementById('wbNextConstraint');
  const wbConstraintNote = document.getElementById('wbConstraintNote');
  const wbOperatorsSum = document.getElementById('wbOperatorsSum');
  const methodGuideText = document.getElementById('methodGuideText');

  const i18n = {
    en:{
      'title.subtitle':'Cycle Time & Capacity Analyzer',
      'btn.start':'Start','btn.pause':'Pause','btn.lap':'LAP',
      'btn.copyAll':'Copy All','btn.copySummary':'Copy Summary','btn.addManualLap':'Add Manual Lap','btn.reset':'Reset',
      'section.measurementSetup':'Measurement Setup',
      'section.contractSummary':'Contract vs Capacity Summary',
      'contract.note':'Uses current process + your laps (Median/P10/P90) with the Measurement Setup assumptions.',
      'section.statsFocus':'Stat Focus',
      'section.dataControls':'Data Controls',
      'section.rawData':'Raw Time Data',
      'section.charts':'Charts (selected process)',
      'section.statsDetail':'Statistical Detail (per process)',
      'section.wbPlanner':'WB – Capacity Planner (by process)',
      'section.methodGuide':'Method & Guide',
      'method.open':'Open',

      'label.process':'Process','label.processPlaceholder':'e.g. Op 30-1',
      'label.mode':'Mode','label.efficiency':'Efficiency %','label.contractPcd':'Contract Cap (pcs/day)',
      'label.hoursPerDay':'Hours / Day','label.daysPerWeek':'Days / Week','label.capView':'Capacity View',
      'label.chartProcessLabel':'Process / Mode:',

      'mode.ct':'Cycle Time (CT)','mode.mld':'Machine & Load/Unload',
      'capView.hour':'per Hour','capView.day':'per Day','capView.week':'per Week',

      'col.index':'#','col.process':'Process','col.mode':'Mode','col.status':'Status','col.note':'Note',
      'col.t1':'T1 (s)','col.t2':'T2 (s)','col.total':'Total (s)','col.edit':'Edit','col.del':'Del','col.n':'N',
      'col.sample':'Sample size / Error',
      'col.capCurrent':'Current @Eff','col.capPotential':'Potential @Eff','col.capWorst':'Worst @Eff',
      'col.contract':'Contract','col.gap':'Gap','col.vsContract':'% vs',
      'col.note':'Note',

      'chart.timeSeriesTitle':'Time Series with Mean, Median, ±3σ',
      'chart.histTitle':'Histogram with Median & Percentiles',

      'stats.note':'Simple language on purpose: few / enough samples, low / high variation, capable / not capable.',
      'footer.note':'Created by Roberto González – Contact: hzaelglez@gmail.com',

      'btn.wbAdd':'+ Add Operation',
      'btn.wbClear':'Clear WB',
      'wb.seq':'Seq',
      'wb.enabled':'On',
      'wb.operation':'Operation',
      'wb.operators':'Operators',
      'wb.shifts':'Shifts',
      'wb.hours':'Hours',
      'wb.machines':'# Machines',
      'wb.contract':'Contract (pcs/day)',
      'wb.gross':'Gross min/day',
      'wb.lunch':'Lunch min/day',
      'wb.changeover':'Changeover (min/day)',
      'wb.cleaning':'5S/Clean (min/day)',
      'wb.maint':'Maintenance (min/day)',
      'wb.other':'Other (min/day)',
      'wb.shared':'Shared Capacity (min/day)',
      'wb.udt':'Unplanned DT',
      'wb.udtUnit':'Unit',
      'wb.net':'Net min/day',
      'wb.scrap':'Scrap %',
      'wb.yield':'Yield',
      'wb.oeeA':'A%',
      'wb.oeeP':'P%',
      'wb.oeeQ':'Q%',
      'wb.oee':'OEE%',
      'wb.ctCur':'CT Current (s)',
      'wb.ctWst':'CT Worst (s)',
      'wb.ctPot':'CT Potential (s)',
      'wb.ctCurOee':'CT@OEE (Cur)',
      'wb.cap100':'Cap 100% (Cur/day)',
      'wb.capOee':'Cap@OEE (Cur/day)',
      'wb.vsContract':'% vs contract',
      'wb.inputReq':'Input req. for Contract',
      'wb.actions':'Actions',
      'wb.constraintTitle':'Constraint / Next:',
      'wb.opsSum':'Operators total:',

      // NEW (pending fix for dynamic labels)
      'focus.stdLabel':'Std dev',
      'focus.meanMedianLabel':'Mean vs Median',
      'wb.relink':'Relink',
      'wb.delete':'Delete'
    },
    es:{
      'title.subtitle':'Analizador de Tiempo de Ciclo y Capacidad',
      'btn.start':'Iniciar','btn.pause':'Pausar','btn.lap':'VUELTA',
      'btn.copyAll':'Copiar todo','btn.copySummary':'Copiar resumen','btn.addManualLap':'Agregar vuelta manual','btn.reset':'Reiniciar',
      'section.measurementSetup':'Configuración de Medición',
      'section.contractSummary':'Resumen Contrato vs Capacidad',
      'contract.note':'Usa el proceso actual + tus vueltas (Mediana/P10/P90) con los supuestos de Measurement Setup.',
      'section.statsFocus':'Enfoque Estadístico',
      'section.dataControls':'Controles de Datos',
      'section.rawData':'Datos Crudos de Tiempo',
      'section.charts':'Gráficas (proceso seleccionado)',
      'section.statsDetail':'Detalle Estadístico (por proceso)',
      'section.wbPlanner':'WB – Planeador de Capacidad (por proceso)',
      'section.methodGuide':'Método & Guía',
      'method.open':'Abrir',

      'label.process':'Proceso','label.processPlaceholder':'p. ej. Op 30-1',
      'label.mode':'Modo','label.efficiency':'Eficiencia %','label.contractPcd':'Capacidad contrato (pzs/día)',
      'label.hoursPerDay':'Horas / día','label.daysPerWeek':'Días / semana','label.capView':'Vista de capacidad',
      'label.chartProcessLabel':'Proceso / Modo:',

      'mode.ct':'Tiempo de ciclo (CT)','mode.mld':'Máquina y Carga/Descarga',
      'capView.hour':'por hora','capView.day':'por día','capView.week':'por semana',

      'col.index':'#','col.process':'Proceso','col.mode':'Modo','col.status':'Estatus','col.note':'Nota',
      'col.t1':'T1 (s)','col.t2':'T2 (s)','col.total':'Total (s)','col.edit':'Editar','col.del':'Borrar','col.n':'N',
      'col.sample':'Tamaño de muestra / Error',
      'col.capCurrent':'Actual @Eff','col.capPotential':'Potencial @Eff','col.capWorst':'Peor @Eff',
      'col.contract':'Contrato','col.gap':'Gap','col.vsContract':'% vs',
      'col.note':'Nota',

      'chart.timeSeriesTitle':'Serie de tiempo con media, mediana y ±3σ',
      'chart.histTitle':'Histograma con mediana y percentiles',

      'stats.note':'Lenguaje simple: pocas / suficientes muestras, baja / alta variación, capaz / no capaz.',
      'footer.note':'Creado por Roberto González – Contacto: hzaelglez@gmail.com',

      'btn.wbAdd':'+ Agregar operación',
      'btn.wbClear':'Borrar WB',
      'wb.seq':'Orden',
      'wb.enabled':'Activo',
      'wb.operation':'Operación',
      'wb.operators':'Operadores',
      'wb.shifts':'Turnos',
      'wb.hours':'Horas',
      'wb.machines':'# Máquinas',
      'wb.contract':'Contrato (pzs/día)',
      'wb.gross':'Min brutos/día',
      'wb.lunch':'Comida/día',
      'wb.changeover':'Changeover (min/día)',
      'wb.cleaning':'5S/Limpieza (min/día)',
      'wb.maint':'Mtto (min/día)',
      'wb.other':'Otros (min/día)',
      'wb.shared':'Capacidad compartida (min/día)',
      'wb.udt':'DT no planeado',
      'wb.udtUnit':'Unidad',
      'wb.net':'Min netos/día',
      'wb.scrap':'Scrap %',
      'wb.yield':'Rendimiento',
      'wb.oeeA':'Disp%',
      'wb.oeeP':'Rend%',
      'wb.oeeQ':'Calidad%',
      'wb.oee':'OEE%',
      'wb.ctCur':'CT Actual (s)',
      'wb.ctWst':'CT Peor (s)',
      'wb.ctPot':'CT Potencial (s)',
      'wb.ctCurOee':'CT@OEE (Act)',
      'wb.cap100':'Cap 100% (Act/día)',
      'wb.capOee':'Cap@OEE (Act/día)',
      'wb.vsContract':'% vs contrato',
      'wb.inputReq':'Entrada req. p/Contrato',
      'wb.actions':'Acciones',
      'wb.constraintTitle':'Restricción / Siguiente:',
      'wb.opsSum':'Operadores total:',

      // NEW (pending fix for dynamic labels)
      'focus.stdLabel':'Desv. estándar',
      'focus.meanMedianLabel':'Media vs Mediana',
      'wb.relink':'Religar',
      'wb.delete':'Borrar'
    }
  };

  let currentLang = localStorage.getItem('taktlabLang') || 'en';
  function t(key){ return (i18n[currentLang] && i18n[currentLang][key]) || i18n.en[key] || key; }

  function applyTranslations(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.dataset.i18n;
      if(el === btnStart) return;
      el.textContent = t(key);
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
      const key = el.dataset.i18nPlaceholder;
      el.placeholder = t(key);
    });
  }
  function updateLangButtons(){ langButtons.forEach(b=>b.classList.toggle('active', b.dataset.lang === currentLang)); }
  function setLanguage(lang){
    currentLang = (lang==='es') ? 'es' : 'en';
    localStorage.setItem('taktlabLang', currentLang);
    document.documentElement.lang = currentLang;
    updateLangButtons();
    applyTranslations();
    btnStart.textContent = running ? t('btn.pause') : t('btn.start');
    renderAll();
  }
  langButtons.forEach(btn=>btn.addEventListener('click',()=>setLanguage(btn.dataset.lang)));

  let running=false, startTime=0, elapsed=0, timerId=null;
  let laps=[], nextId=1;
  let pendingT1=null;

  const WB_KEY = 'taktlabWB_v2_sync';

  function clamp(n,min,max){ n = isFinite(n)?n:0; return Math.min(Math.max(n,min),max); }
  function pad2(n){return n<10?'0'+n:''+n;}
  function formatTime(ms){
    const total=Math.max(ms,0);
    const mins=Math.floor(total/60000);
    const secs=Math.floor((total%60000)/1000);
    const cent=Math.floor((total%1000)/10);
    return pad2(mins)+':'+pad2(secs)+'.'+pad2(cent);
  }
  function formatSecs(s){
    if(!isFinite(s)) return '-';
    return (Math.round(s*10)/10).toFixed(1);
  }
  function formatUnits(n){
    if(!isFinite(n)) return '-';
    const rounded=Math.round(n);
    return rounded.toLocaleString('en-US',{maximumFractionDigits:0});
  }
  function pct(n, digits=0){ if(!isFinite(n)) return '-'; return n.toFixed(digits)+'%'; }

  function updateDisplay(){ display.textContent = formatTime(elapsed); }
  function refreshRingStates(){
    if(!running){ logoGear.classList.remove('spinning'); return; }
    logoGear.classList.add('spinning');
  }
  function tick(){
    const now=performance.now();
    elapsed=now-startTime;
    updateDisplay();
    timerId=requestAnimationFrame(tick);
  }
  function start(){
    if(running) return;
    running=true;
    startTime=performance.now()-elapsed;
    timerId=requestAnimationFrame(tick);
    btnStart.textContent=t('btn.pause');
    refreshRingStates();
  }
  function pause(){
    if(!running) return;
    running=false;
    cancelAnimationFrame(timerId);
    timerId=null;
    btnStart.textContent=t('btn.start');
    refreshRingStates();
  }
  btnStart.addEventListener('click',()=>{ running?pause():start(); });

  function flashCard(){ timerCard.classList.add('flash'); setTimeout(()=>timerCard.classList.remove('flash'),120); }
  function vibrate(ms=18){ try{ if(navigator.vibrate) navigator.vibrate(ms); }catch(e){} }

  // ======== PARTE 2/6 CONTINÚA DESDE AQUÍ ========
  function getCurrentProcess(){ return (processInput.value||'').trim(); }
  function getCurrentMode(){ return modeSelect.value; }

  function addLapFromSeconds(t1, t2, total, status='OK', note=''){
    const proc = getCurrentProcess() || (currentLang==='es' ? 'Sin nombre' : 'Unnamed');
    const mode = getCurrentMode();
    laps.push({
      id: nextId++,
      process: proc,
      mode,
      status,
      note,
      t1: (mode==='MLD') ? t1 : null,
      t2: (mode==='MLD') ? t2 : null,
      total: total
    });
    saveAll();
    renderAll();
  }

  btnLap.addEventListener('click', ()=>{
    flashCard(); vibrate(18);

    const proc = getCurrentProcess();
    if(!proc){
      alert(currentLang==='es' ? 'Primero escribe un nombre de proceso.' : 'Please enter a process name first.');
      processInput.focus();
      return;
    }

    // If not running, still allow lap capture from elapsed (acts like a "stamp")
    const nowMs = elapsed;

    if(getCurrentMode()==='CT'){
      // Single-stamp lap: use delta between laps by resetting elapsed
      // If user wants continuous, they can pause/resume; this keeps it "stopwatch-lap" style.
      const lapSec = nowMs/1000;
      if(lapSec <= 0.01){
        alert(currentLang==='es' ? 'Tiempo demasiado corto. Intenta de nuevo.' : 'Lap too short. Try again.');
        return;
      }
      addLapFromSeconds(null,null,lapSec,'OK','');
      // reset for next lap
      elapsed = 0;
      if(running) startTime = performance.now();
      updateDisplay();
      return;
    }

    // MLD mode: first click captures T1, second click captures T2 and Total
    if(pendingT1===null){
      pendingT1 = nowMs/1000;
      elapsed = 0;
      if(running) startTime = performance.now();
      updateDisplay();
      sampleInfoTop.textContent = (currentLang==='es')
        ? `T1 capturado: ${formatSecs(pendingT1)}s. Captura T2.`
        : `T1 captured: ${formatSecs(pendingT1)}s. Capture T2.`;
      return;
    }else{
      const t2 = nowMs/1000;
      const t1 = pendingT1;
      pendingT1 = null;
      const total = t1 + t2;
      if(total <= 0.02){
        alert(currentLang==='es' ? 'Tiempo inválido. Repite la medición.' : 'Invalid time. Repeat.');
        return;
      }
      addLapFromSeconds(t1,t2,total,'OK','');
      elapsed = 0;
      if(running) startTime = performance.now();
      updateDisplay();
      return;
    }
  });

  // ==========================
  // Storage (laps + WB)
  // ==========================
  const STORAGE_KEY = 'taktlab_laps_v6_full';

  function saveAll(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ nextId, laps }));
    }catch(e){}
  }
  function loadAll(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const obj = JSON.parse(raw);
      if(obj && Array.isArray(obj.laps)){
        laps = obj.laps;
        nextId = obj.nextId || (laps.length+1);
      }
    }catch(e){}
  }

  // ==========================
  // Stats utils
  // ==========================
  function sortedNums(arr){
    return arr.slice().filter(x=>isFinite(x)).sort((a,b)=>a-b);
  }
  function mean(arr){
    const a=arr.filter(x=>isFinite(x));
    if(!a.length) return NaN;
    return a.reduce((s,v)=>s+v,0)/a.length;
  }
  function stdev(arr){
    const a=arr.filter(x=>isFinite(x));
    if(a.length<2) return NaN;
    const m=mean(a);
    const v=a.reduce((s,x)=>s+(x-m)*(x-m),0)/(a.length-1);
    return Math.sqrt(v);
  }
  function percentile(arr,p){
    const a=sortedNums(arr);
    if(!a.length) return NaN;
    const idx=(a.length-1)*p;
    const lo=Math.floor(idx), hi=Math.ceil(idx);
    if(lo===hi) return a[lo];
    const w=idx-lo;
    return a[lo]*(1-w)+a[hi]*w;
  }
  function median(arr){ return percentile(arr,0.5); }

  function groupKey(l){ return `${l.process}||${l.mode}`; }
  function groupLaps(){
    const map=new Map();
    for(const l of laps){
      const k=groupKey(l);
      if(!map.has(k)) map.set(k, []);
      map.get(k).push(l);
    }
    return map;
  }

  function computeGroupStats(groupArr){
    const totals = groupArr.map(x=>x.total).filter(x=>isFinite(x));
    const n = totals.length;
    if(!n) return null;

    const mn = mean(totals);
    const md = median(totals);
    const p10 = percentile(totals,0.10);
    const p90 = percentile(totals,0.90);
    const minv = percentile(totals,0.0);
    const maxv = percentile(totals,1.0);
    const sd = stdev(totals);
    const cv = (isFinite(sd) && isFinite(mn) && mn>0) ? (sd/mn*100) : NaN;

    // Capability indices (approx): assume USL = P90, LSL = P10
    const usl = p90, lsl = p10;
    const cp = (isFinite(usl)&&isFinite(lsl)&&isFinite(sd)&&sd>0) ? ((usl-lsl)/(6*sd)) : NaN;
    const cpk = (isFinite(usl)&&isFinite(lsl)&&isFinite(sd)&&sd>0&&isFinite(mn))
      ? Math.min((usl-mn)/(3*sd),(mn-lsl)/(3*sd))
      : NaN;

    return { n, mn, md, p10, p90, minv, maxv, sd, cv, cp, cpk };
  }

  // ==========================
  // Sample size + error messaging
  // ==========================
  function estRelError95(sd, meanVal, n){
    // relative half-width approx: 1.96 * sd / sqrt(n) / mean
    if(!isFinite(sd)||!isFinite(meanVal)||!isFinite(n)||n<=0||meanVal<=0) return NaN;
    return 1.96 * (sd/Math.sqrt(n)) / meanVal;
  }

  function sampleNarrative(stats){
    if(!stats) return { cls:'sample-neutral', text:(currentLang==='es'?'Sin datos aún.':'No data yet.') };

    const n = stats.n;
    const err = estRelError95(stats.sd, stats.mn, n); // relative
    const errPct = isFinite(err) ? err*100 : NaN;

    // rules of thumb
    if(n < 5){
      return {
        cls:'sample-bad',
        text:(currentLang==='es')
          ? `Muestras: ${n} · Error est.: ${isFinite(errPct)?('±'+errPct.toFixed(1)+'% (95%)'):'—'} — Muy pocas. Usa solo como referencia.`
          : `Samples: ${n} · Est. error: ${isFinite(errPct)?('±'+errPct.toFixed(1)+'% (95%)'):'—'} — Too few. Reference only.`
      };
    }
    if(n < 15){
      return {
        cls:'sample-warn',
        text:(currentLang==='es')
          ? `Muestras: ${n} · Error est.: ${isFinite(errPct)?('±'+errPct.toFixed(1)+'% (95%)'):'—'} — Casi suficiente; unas vueltas más ayudarían.`
          : `Samples: ${n} · Est. error: ${isFinite(errPct)?('±'+errPct.toFixed(1)+'% (95%)'):'—'} — Almost enough; a couple more laps would help.`
      };
    }
    if(isFinite(errPct) && errPct > 5){
      return {
        cls:'sample-warn',
        text:(currentLang==='es')
          ? `Muestras: ${n} · Error est.: ±${errPct.toFixed(1)}% (95%) — Variación alta; captura más para afinar.`
          : `Samples: ${n} · Est. error: ±${errPct.toFixed(1)}% (95%) — High variation; take more samples.`
      };
    }
    return {
      cls:'sample-good',
      text:(currentLang==='es')
        ? `Muestras: ${n} · Error est.: ${isFinite(errPct)?('±'+errPct.toFixed(1)+'% (95%)'):'—'} — Suficiente para tomar decisión.`
        : `Samples: ${n} · Est. error: ${isFinite(errPct)?('±'+errPct.toFixed(1)+'% (95%)'):'—'} — Good enough for decisions.`
    };
  }

  // ==========================
  // Capacity math
  // ==========================
  function getAssumptions(){
    const eff = clamp(parseFloat(effInput.value),0,100)/100;
    const hrs = clamp(parseFloat(hInput.value),0,24);
    const days = clamp(parseFloat(dInput.value),0,7);
    const contract = clamp(parseFloat(pcdInput.value),0,999999);
    const view = capViewSel.value;
    return { eff, hrs, days, contract, view };
  }

  function capFromCT(ctSeconds, eff, hrs){
    if(!isFinite(ctSeconds) || ctSeconds<=0) return NaN;
    const secAvail = hrs*3600*eff;
    return secAvail/ctSeconds; // pcs/day (for hrs/day)
  }

  function viewConvert(pcd, view, hrs, days){
    if(!isFinite(pcd)) return NaN;
    if(view==='day') return pcd;
    if(view==='hour') return pcd/hrs;
    if(view==='week') return pcd*days;
    return pcd;
  }

  // ==========================
  // Render helpers
  // ==========================
  function esc(s){ return (''+s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

  function rebuildChartSelect(groups){
    const prev = chartSelect.value;
    chartSelect.innerHTML = '';
    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = currentLang==='es' ? '— Selecciona —' : '— Select —';
    chartSelect.appendChild(opt0);

    for(const [k, arr] of groups.entries()){
      const [proc, mode] = k.split('||');
      const o = document.createElement('option');
      o.value = k;
      o.textContent = `${proc} · ${mode}`;
      chartSelect.appendChild(o);
    }
    if(prev && [...chartSelect.options].some(o=>o.value===prev)) chartSelect.value = prev;
  }

  function renderSampleTop(currentStats){
    const msg = sampleNarrative(currentStats);
    sampleInfoTop.className = `info-line ${msg.cls}`;
    sampleInfoTop.textContent = msg.text;
  }

  function renderFocusPanel(currentStats, contract, capNowView){
    if(!currentStats){
      sampleInfoFocus.textContent = currentLang==='es' ? 'Muestras: —' : 'Sample size: —';
      stdInfoFocus.textContent = `${t('focus.stdLabel')}: —`;
      distInfoFocus.textContent = `${t('focus.meanMedianLabel')}: —`;
      contractInfoFocus.textContent = currentLang==='es' ? 'Contrato: —' : 'Contract: —';
      return;
    }
    const err = estRelError95(currentStats.sd, currentStats.mn, currentStats.n);
    const errPct = isFinite(err) ? (err*100).toFixed(1) : '—';

    sampleInfoFocus.textContent = (currentLang==='es')
      ? `Muestras: ${currentStats.n} / Error est.: ±${errPct}% (95%)`
      : `Samples: ${currentStats.n} / Est. error: ±${errPct}% (95%)`;

    stdInfoFocus.textContent = `${t('focus.stdLabel')}: ${isFinite(currentStats.sd)?currentStats.sd.toFixed(2):'—'}s (CV ${isFinite(currentStats.cv)?currentStats.cv.toFixed(1):'—'}%)`;

    const skew = (isFinite(currentStats.mn) && isFinite(currentStats.md))
      ? (Math.abs(currentStats.mn-currentStats.md)/currentStats.md*100)
      : NaN;

    distInfoFocus.textContent = `${t('focus.meanMedianLabel')}: ${isFinite(currentStats.mn)?currentStats.mn.toFixed(2):'—'} vs ${isFinite(currentStats.md)?currentStats.md.toFixed(2):'—'} (${isFinite(skew)?skew.toFixed(1)+'%':''})`;

    if(contract>0 && isFinite(capNowView)){
      const gap = capNowView - viewConvert(contract, getAssumptions().view, getAssumptions().hrs, getAssumptions().days);
      const ok = gap>=0;
      contractInfoFocus.textContent = ok
        ? (currentLang==='es' ? `Contrato OK · +${formatUnits(gap)} vs contrato (vista)` : `Contract OK · +${formatUnits(gap)} vs contract (view)`)
        : (currentLang==='es' ? `Contrato NO · ${formatUnits(gap)} vs contrato (vista)` : `Contract NO · ${formatUnits(gap)} vs contract (view)`);
    }else{
      contractInfoFocus.textContent = currentLang==='es' ? 'Contrato: —' : 'Contract: —';
    }
  }

  // ==========================
  // Data table (raw)
  // ==========================
  function renderDataTable(){
    dataBody.innerHTML = '';
    laps.forEach((l,idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${esc(l.process)}</td>
        <td>${esc(l.mode)}</td>
        <td>${esc(l.status||'OK')}</td>
        <td>${esc(l.note||'')}</td>
        <td>${l.mode==='MLD' ? formatSecs(l.t1) : '-'}</td>
        <td>${l.mode==='MLD' ? formatSecs(l.t2) : '-'}</td>
        <td>${formatSecs(l.total)}</td>
        <td><button class="btn-edit" data-id="${l.id}">${currentLang==='es'?'Editar':'Edit'}</button></td>
        <td><button class="btn-del" data-id="${l.id}">${currentLang==='es'?'Borrar':'Del'}</button></td>
      `;
      dataBody.appendChild(tr);
    });

    dataBody.querySelectorAll('.btn-del').forEach(b=>{
      b.addEventListener('click',()=>{
        const id = parseInt(b.dataset.id,10);
        laps = laps.filter(x=>x.id!==id);
        saveAll();
        renderAll();
      });
    });

    dataBody.querySelectorAll('.btn-edit').forEach(b=>{
      b.addEventListener('click',()=>{
        const id = parseInt(b.dataset.id,10);
        const lap = laps.find(x=>x.id===id);
        if(!lap) return;

        const p = prompt(currentLang==='es' ? 'Proceso:' : 'Process:', lap.process);
        if(p===null) return;
        const n = prompt(currentLang==='es' ? 'Nota:' : 'Note:', lap.note||'');
        if(n===null) return;

        let ttotal = prompt(currentLang==='es' ? 'Total (segundos):' : 'Total (seconds):', String(lap.total));
        if(ttotal===null) return;
        const v = parseFloat(ttotal);
        if(!isFinite(v) || v<=0){ alert(currentLang==='es'?'Total inválido.':'Invalid total.'); return; }

        lap.process = (p||'').trim() || lap.process;
        lap.note = (n||'').trim();
        lap.total = v;

        if(lap.mode==='MLD'){
          let tt1 = prompt(currentLang==='es'?'T1 (segundos):':'T1 (seconds):', String(lap.t1||0));
          if(tt1===null) return;
          let tt2 = prompt(currentLang==='es'?'T2 (segundos):':'T2 (seconds):', String(lap.t2||0));
          if(tt2===null) return;
          const v1=parseFloat(tt1), v2=parseFloat(tt2);
          if(isFinite(v1)&&isFinite(v2)&&v1>=0&&v2>=0){
            lap.t1=v1; lap.t2=v2;
            lap.total = v1+v2;
          }
        }

        saveAll();
        renderAll();
      });
    });
  }

  // ======== PARTE 3/6 CONTINÚA DESDE AQUÍ ========
  // ==========================
  // Focus + Stats tables
  // ==========================
  function renderStatsDetail(groups){
    statsBody.innerHTML = '';
    if(!groups.size){
      const tr=document.createElement('tr');
      tr.innerHTML = `<td colspan="13" style="text-align:left;color:var(--text-muted);">
        ${currentLang==='es' ? 'Sin datos.' : 'No data.'}
      </td>`;
      statsBody.appendChild(tr);
      return;
    }

    const ctTarget = computeCtTargetSeconds(); // from contractPcd + hours/day
    for(const [k, arr] of groups.entries()){
      const [proc, mode] = k.split('||');
      const st = computeGroupStats(arr);
      if(!st) continue;

      let cp='-', cpk='-';
      if(ctTarget && isFinite(st.sd) && st.sd>0){
        const USL = ctTarget, LSL = 0;
        const cpv = (USL-LSL)/(6*st.sd);
        const cpu = (USL-st.mn)/(3*st.sd);
        const cpl = (st.mn-LSL)/(3*st.sd);
        cp = isFinite(cpv)?cpv.toFixed(2):'-';
        cpk = isFinite(Math.min(cpu,cpl))?Math.min(cpu,cpl).toFixed(2):'-';
      }else{
        cp = isFinite(st.cp)?st.cp.toFixed(2):'-';
        cpk = isFinite(st.cpk)?st.cpk.toFixed(2):'-';
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(proc)}</td>
        <td>${esc(mode)}</td>
        <td>${st.n}</td>
        <td>${isFinite(st.mn)?st.mn.toFixed(2):'-'}</td>
        <td>${isFinite(st.md)?st.md.toFixed(2):'-'}</td>
        <td>${isFinite(st.p10)?st.p10.toFixed(2):'-'}</td>
        <td>${isFinite(st.p90)?st.p90.toFixed(2):'-'}</td>
        <td>${isFinite(st.minv)?st.minv.toFixed(2):'-'}</td>
        <td>${isFinite(st.maxv)?st.maxv.toFixed(2):'-'}</td>
        <td>${isFinite(st.sd)?st.sd.toFixed(2):'-'}</td>
        <td>${isFinite(st.cv)?st.cv.toFixed(1):'-'}</td>
        <td>${cp}</td>
        <td>${cpk}</td>
      `;
      statsBody.appendChild(tr);
    }
  }

  function renderFocusTable(groups){
    focusBody.innerHTML = '';

    if(!groups.size){
      const tr=document.createElement('tr');
      tr.innerHTML = `<td colspan="18" style="text-align:left;color:var(--text-muted);">
        ${currentLang==='es'
          ? 'Sin muestras aún. Toma vueltas y aquí se llenará la tabla.'
          : 'No samples yet. Take laps and this table will populate.'}
      </td>`;
      focusBody.appendChild(tr);
      return;
    }

    const { eff, hrs, days, contract, view } = getAssumptions();
    const contractUnitsView = viewConvert(contract, view, hrs, days);

    const keys = [...groups.keys()].sort((a,b)=>a.localeCompare(b));
    for(const k of keys){
      const [proc, mode] = k.split('||');
      const arr = groups.get(k);
      const st = computeGroupStats(arr);
      if(!st) continue;

      // Capacity baseline uses CT median/p10/p90 and "eff" and hrs/day. Then convert to view.
      const capDayCur = capFromCT(st.md, eff, hrs);
      const capDayPot = capFromCT(st.p10, eff, hrs);
      const capDayWst = capFromCT(st.p90, eff, hrs);

      const capViewCur = (view==='day') ? capDayCur : (view==='hour' ? (capDayCur/hrs) : (capDayCur*days));
      const capViewPot = (view==='day') ? capDayPot : (view==='hour' ? (capDayPot/hrs) : (capDayPot*days));
      const capViewWst = (view==='day') ? capDayWst : (view==='hour' ? (capDayWst/hrs) : (capDayWst*days));

      const pctVs = (contract>0 && isFinite(capViewCur)) ? (capViewCur/contractUnitsView*100) : NaN;
      const gap = (contract>0 && isFinite(capViewCur)) ? (capViewCur - contractUnitsView) : NaN;

      let badgeClass='';
      if(isFinite(pctVs)){
        if(pctVs<85) badgeClass='badge-bad';
        else if(pctVs<100) badgeClass='badge-warn';
        else badgeClass='badge-good';
      }

      const msg = sampleNarrative(st);
      let note='';
      if(st.n<5) note = currentLang==='es' ? 'Muestra chica: no te cases.' : 'Tiny sample: don’t marry it.';
      else if(isFinite(st.cv) && st.cv>20) note = currentLang==='es' ? 'Alta variación: hay fantasmas.' : 'High variation: ghosts here.';
      else if(isFinite(pctVs) && pctVs<100) note = currentLang==='es' ? 'No alcanza contrato.' : 'Below contract.';
      else note = currentLang==='es' ? 'Se ve sano.' : 'Looks healthy.';

      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(proc)}</td>
        <td>${esc(mode)}</td>
        <td>${st.n}</td>
        <td style="text-align:left">${esc(msg.text)}</td>
        <td>${isFinite(st.sd)?st.sd.toFixed(2):'-'}</td>
        <td>${isFinite(st.cv)?st.cv.toFixed(1):'-'}</td>
        <td>${isFinite(st.md)?st.md.toFixed(2):'-'}</td>
        <td>${isFinite(st.p10)?st.p10.toFixed(2):'-'}</td>
        <td>${isFinite(st.p90)?st.p90.toFixed(2):'-'}</td>
        <td>${isFinite(capViewCur)?formatUnits(capViewCur):'-'}</td>
        <td>${isFinite(capViewPot)?formatUnits(capViewPot):'-'}</td>
        <td>${isFinite(capViewWst)?formatUnits(capViewWst):'-'}</td>
        <td>${contract>0?formatUnits(contractUnitsView):'-'}</td>
        <td>${isFinite(gap)?((gap>=0?'+':'')+formatUnits(gap)):'-'}</td>
        <td>${isFinite(pctVs)?`<span class="badge ${badgeClass}">${pctVs.toFixed(0)}%</span>`:'-'}</td>
        <td>${isFinite(st.cp)?st.cp.toFixed(2):'-'}</td>
        <td>${isFinite(st.cpk)?st.cpk.toFixed(2):'-'}</td>
        <td style="text-align:left;color:var(--text-soft)">${esc(note)}</td>
      `;
      focusBody.appendChild(tr);
    }
  }

  // ==========================
  // Contract vs Capacity Summary (top 4 lines)
  // ==========================
  function updateContractSummary(groups){
    const proc = getCurrentProcess();
    const mode = getCurrentMode();
    const key = `${proc}||${mode}`;
    const arr = groups.get(key) || [];
    const st = computeGroupStats(arr);

    const { eff, hrs, days, contract, view } = getAssumptions();
    const contractUnitsView = viewConvert(contract, view, hrs, days);

    if(!st){
      setInfo(contractSumLine1,'sample-neutral', currentLang==='es' ? 'Sin muestras para el proceso actual.' : 'No samples for current process.');
      setInfo(contractSumLine2,'sample-neutral', currentLang==='es' ? 'Toma vueltas para calcular CT (mediana/P10/P90).' : 'Capture laps to compute CT (Median/P10/P90).');
      setInfo(contractSumLine3,'sample-neutral', currentLang==='es' ? 'Contrato: —' : 'Contract: —');
      setInfo(contractSumLine4,'sample-neutral', currentLang==='es' ? 'Resultado: —' : 'Result: —');
      return;
    }

    const capDayCur = capFromCT(st.md, eff, hrs);
    const capDayPot = capFromCT(st.p10, eff, hrs);
    const capDayWst = capFromCT(st.p90, eff, hrs);

    const capViewCur = (view==='day') ? capDayCur : (view==='hour' ? (capDayCur/hrs) : (capDayCur*days));
    const capViewPot = (view==='day') ? capDayPot : (view==='hour' ? (capDayPot/hrs) : (capDayPot*days));
    const capViewWst = (view==='day') ? capDayWst : (view==='hour' ? (capDayWst/hrs) : (capDayWst*days));

    setInfo(contractSumLine1,'sample-neutral',
      (currentLang==='es'
        ? `Proceso: ${proc} (${mode}) · Vista: ${view==='hour'?'hora':(view==='day'?'día':'semana')} · Eff: ${(eff*100).toFixed(0)}%`
        : `Process: ${proc} (${mode}) · View: ${view} · Eff: ${(eff*100).toFixed(0)}%`
      )
    );

    setInfo(contractSumLine2,'sample-neutral',
      (currentLang==='es'
        ? `Capacidad (Cur/Med): ${formatUnits(capViewCur)} | Pot (P10): ${formatUnits(capViewPot)} | Worst (P90): ${formatUnits(capViewWst)}`
        : `Capacity (Cur/Med): ${formatUnits(capViewCur)} | Pot (P10): ${formatUnits(capViewPot)} | Worst (P90): ${formatUnits(capViewWst)}`
      )
    );

    if(contract<=0){
      setInfo(contractSumLine3,'sample-neutral', currentLang==='es'
        ? 'Contrato: no cargado (Contract Cap = 0).'
        : 'Contract: not loaded (Contract Cap = 0).');
      setInfo(contractSumLine4,'sample-neutral', currentLang==='es'
        ? 'Resultado: define contrato para evaluar.'
        : 'Result: set a contract to evaluate.');
      return;
    }

    const gap = capViewCur - contractUnitsView;
    const pctVs = (capViewCur/contractUnitsView)*100;

    let cls='sample-bad';
    let msg = currentLang==='es' ? 'No alcanza.' : 'Below target.';
    if(pctVs>=85 && pctVs<100){ cls='sample-warn'; msg = currentLang==='es' ? 'Muy justo.' : 'Tight.'; }
    if(pctVs>=100){ cls='sample-good'; msg = currentLang==='es' ? 'Cumple contrato.' : 'Meets contract.'; }

    setInfo(contractSumLine3, cls,
      (currentLang==='es'
        ? `Contrato: ${formatUnits(contractUnitsView)} · Cap@Eff: ${formatUnits(capViewCur)} · Gap: ${(gap>=0?'+':'')+formatUnits(gap)}`
        : `Contract: ${formatUnits(contractUnitsView)} · Cap@Eff: ${formatUnits(capViewCur)} · Gap: ${(gap>=0?'+':'')+formatUnits(gap)}`
      )
    );

    setInfo(contractSumLine4, cls,
      (currentLang==='es'
        ? `Resultado: ${pctVs.toFixed(0)}% vs contrato – ${msg}`
        : `Result: ${pctVs.toFixed(0)}% vs contract – ${msg}`
      )
    );
  }

  // ==========================
  // Semaphores (Top + Focus panel)
  // ==========================
  function updateSemaphores(groups){
    const proc = getCurrentProcess();
    const mode = getCurrentMode();
    const key = `${proc}||${mode}`;
    const arr = groups.get(key) || [];
    const st = computeGroupStats(arr);

    renderSampleTop(st);

    const { contract, view, hrs, days, eff } = getAssumptions();
    // compute cap for current group (view units)
    let capNowView = NaN;
    if(st){
      const capDayCur = capFromCT(st.md, eff, hrs);
      capNowView = (view==='day') ? capDayCur : (view==='hour' ? (capDayCur/hrs) : (capDayCur*days));
    }
    renderFocusPanel(st, contract, capNowView);
    updateContractSummary(groups);
  }

  // ==========================
  // Copy controls
  // ==========================
  async function copyToClipboard(text){
    if(!text) return;
    try{
      await navigator.clipboard.writeText(text);
      alert(currentLang==='es'?'Copiado.':'Copied.');
    }catch(e){
      const ta=document.createElement('textarea');
      ta.value=text;
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand('copy'); alert(currentLang==='es'?'Copiado.':'Copied.'); }
      catch(err){ alert(currentLang==='es'?'No disponible el portapapeles.':'Clipboard not available.'); }
      document.body.removeChild(ta);
    }
  }

  btnCopyAll.addEventListener('click', ()=>{
    if(!laps.length){ alert(currentLang==='es'?'No hay datos.':'No data.'); return; }
    const header = currentLang==='es'
      ? ['#','Proceso','Modo','Estatus','Nota','T1 (s)','T2 (s)','Total (s)']
      : ['#','Process','Mode','Status','Note','T1 (s)','T2 (s)','Total (s)'];

    const rows = laps.map((l,i)=>[
      i+1, l.process, l.mode, l.status||'OK', l.note||'',
      (l.mode==='MLD' ? formatSecs(l.t1) : ''),
      (l.mode==='MLD' ? formatSecs(l.t2) : ''),
      formatSecs(l.total)
    ].join('\t'));

    copyToClipboard(header.join('\t')+'\n'+rows.join('\n'));
  });

  // ======== PARTE 4/6 CONTINÚA DESDE AQUÍ ========
  // ============================================================
  // WB – DATA MODEL + PERSISTENCE + AUTO-LINK WITH MEASUREMENT SETUP
  // ============================================================
  const WB_KEY = 'taktlabWB_v2_sync';
  let wbRows = [];

  function defaultWbRow(){
    const globalHours    = clamp(num(hoursPerDay.value, 8), 1, 24);
    const globalContract = clamp(num(contractPcd.value, 0), 0, 99999);
    const globalQ        = clamp(num(efficiency.value, 100), 0, 100);

    return {
      id: 'wb_' + Math.random().toString(36).slice(2,9),
      seq: 10,
      enabled: true,

      operation: '',
      opAuto: true,

      operators: 1,
      shifts: 1,
      hours: globalHours,
      hoursAuto: true,

      machines: 1,

      contractPcd: globalContract,
      contractAuto: true,

      changeoverMin: 0,
      cleanMin: 0,
      maintMin: 0,
      otherMin: 0,

      sharedMin: 0,

      udtValue: 0,
      udtUnit: 'min_day',   // 'min_day' | 'sec_hour'

      scrapPct: 0,

      oeeA: 100,
      oeeP: 100,
      oeeQ: globalQ,
      qAuto: true,

      // Manual CT override (optional)
      ctCurManual: null,
      ctWstManual: null,
      ctPotManual: null
    };
  }

  function loadWB(){
    try{
      const raw = localStorage.getItem(WB_KEY);
      if(!raw){ wbRows = []; return; }
      const parsed = JSON.parse(raw);
      wbRows = Array.isArray(parsed) ? parsed : [];
    }catch(e){
      wbRows = [];
    }
  }

  function saveWB(){
    try{ localStorage.setItem(WB_KEY, JSON.stringify(wbRows)); }
    catch(e){}
  }

  function applyGlobalToRow(row){
    const gHours    = clamp(num(hoursPerDay.value, 8), 1, 24);
    const gContract = clamp(num(contractPcd.value, 0), 0, 99999);
    const gQ        = clamp(num(efficiency.value, 100), 0, 100);
    const gOp       = (processName.value || '').trim();

    if(row.opAuto)       row.operation  = gOp || row.operation;
    if(row.hoursAuto)    row.hours      = gHours;
    if(row.contractAuto) row.contractPcd= gContract;
    if(row.qAuto)        row.oeeQ       = gQ;
  }

  function ensureWbRowForOperation(opName){
    const op = (opName || '').trim();
    if(!op) return;

    let row = wbRows.find(r => (r.operation||'').trim() === op);
    if(!row){
      row = defaultWbRow();
      const maxSeq = wbRows.reduce((m,x)=>Math.max(m, num(x.seq,0)), 0);
      row.seq = clamp((maxSeq||0) + 10, 0, 99);
      row.operation = op;
      row.opAuto = true;
      wbRows.push(row);
      saveWB();
    }
  }

  // ============================================================
  // WB – CALC HELPERS
  // ============================================================
  function lunchMinutesPerShift(hours){
    if(hours<=6) return 15;
    if(hours<=8) return 30;
    if(hours<=10) return 45;
    return 60;
  }

  function computeUdtMinutes(row){
    const shifts = clamp(num(row.shifts,1), 1, 3);
    const hours  = clamp(num(row.hours,8),  1, 24);
    const v      = clamp(num(row.udtValue,0),0,999);

    if(row.udtUnit === 'sec_hour'){
      const totalSeconds = v * (hours*shifts);
      return totalSeconds/60;
    }
    return v; // min/day
  }

  function computeGrossMinutes(row){
    const shifts   = clamp(num(row.shifts,1), 1, 3);
    const hours    = clamp(num(row.hours,8),  1, 24);
    const machines = clamp(num(row.machines,1),1,99);
    return hours*60*shifts*machines;
  }

  function computeLunchMinutes(row){
    const shifts = clamp(num(row.shifts,1), 1, 3);
    const hours  = clamp(num(row.hours,8),  1, 24);
    return lunchMinutesPerShift(hours) * shifts;
  }

  function computeNetMinutes(row){
    const gross = computeGrossMinutes(row);
    const lunch = computeLunchMinutes(row);

    const changeover = clamp(num(row.changeoverMin,0),0,999);
    const clean      = clamp(num(row.cleanMin,0),0,999);
    const maint      = clamp(num(row.maintMin,0),0,999);
    const other      = clamp(num(row.otherMin,0),0,999);
    const shared     = clamp(num(row.sharedMin,0),0,999);
    const udt        = computeUdtMinutes(row);

    const net = gross - lunch - changeover - clean - maint - other - shared - udt;
    return Math.max(0, net);
  }

  function computeOeePct(row){
    const a = clamp(num(row.oeeA,100),0,100)/100;
    const p = clamp(num(row.oeeP,100),0,100)/100;
    const q = clamp(num(row.oeeQ,100),0,100)/100;
    return clamp(a*p*q,0,1);
  }

  function computeScrapYield(row){
    const scrap = clamp(num(row.scrapPct,0),0,100)/100;
    return (1 - scrap);
  }

  function computeCapacityPerDay(netMinutes, ctSeconds){
    if(!isFinite(netMinutes) || netMinutes<=0) return 0;
    if(!isFinite(ctSeconds)  || ctSeconds<=0)  return 0;
    return (netMinutes*60)/ctSeconds;
  }

  // ============================================================
  // Pull CT from Time Study (laps) by operation name OR manual CTs
  // ============================================================
  function getStudyStatsForOperation(opName){
    const groups = buildGroups();
    let best = null;

    groups.forEach((arr,key)=>{
      const [proc,mode] = key.split('||');
      if((proc||'').trim() === (opName||'').trim()){
        const st = computeGroupStats(arr);
        if(st && st.n>=1){
          if(!best) best = {st, mode};
          else if(best.mode!=='CT' && mode==='CT') best={st,mode};
          else if(st.n > best.st.n) best={st,mode};
        }
      }
    });

    return best;
  }

  function getCtTriple(row){
    const study = getStudyStatsForOperation(row.operation);

    if(study && study.st){
      const st = study.st;
      return { cur: st.md, wst: st.p90, pot: st.p10, source: `study (${study.mode}, N=${st.n})` };
    }

    const cur = row.ctCurManual!=null ? num(row.ctCurManual, NaN) : NaN;
    const wst = row.ctWstManual!=null ? num(row.ctWstManual, NaN) : NaN;
    const pot = row.ctPotManual!=null ? num(row.ctPotManual, NaN) : NaN;

    return { cur:isFinite(cur)?cur:NaN, wst:isFinite(wst)?wst:NaN, pot:isFinite(pot)?pot:NaN, source:'manual' };
  }

  // ============================================================
  // WB – RENDER TABLE
  // ============================================================
  function renderWB(){
    // Apply global auto links
    wbRows.forEach(applyGlobalToRow);

    // Sort
    wbRows.sort((a,b)=>{
      const sa = num(a.seq,0), sb = num(b.seq,0);
      if(sa!==sb) return sa-sb;
      return (a.operation||'').localeCompare(b.operation||'');
    });

    wbBody.innerHTML = '';
    let opsSum = 0;

    wbRows.forEach((row)=>{
      opsSum += clamp(num(row.operators,0),0,99);

      const gross = computeGrossMinutes(row);
      const lunch = computeLunchMinutes(row);
      const net   = computeNetMinutes(row);

      const oee    = computeOeePct(row);
      const oeePct = oee*100;

      const y    = computeScrapYield(row);
      const yPct = y*100;

      const ct = getCtTriple(row);
      const ctCur = ct.cur, ctWst = ct.wst, ctPot = ct.pot;

      const ctCurOee = (isFinite(ctCur) && oee>0) ? (ctCur/oee) : NaN;

      const cap100Cur = computeCapacityPerDay(net, ctCur);
      const capOeeCur = cap100Cur * oee;

      const contract = clamp(num(row.contractPcd,0),0,99999);
      const vs = (contract>0) ? (capOeeCur/contract*100) : NaN;

      const inputReq = (contract>0 && y>0) ? (contract / y) : NaN;

      const inp = (val, extraClass='', title='') =>
        `<input title="${title}" class="wb-inp ${extraClass}" value="${val==null?'':val}">`;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${inp(clamp(num(row.seq,0),0,99),'slim','Max 99')}</td>
        <td style="text-align:center"><input type="checkbox" class="wb-chk" ${row.enabled?'checked':''}></td>

        <td><input class="wb-inp wide" value="${row.operation||''}"
          placeholder="${currentLang==='es'?'p. ej. Op 30-1':'e.g. Op 30-1'}"
          title="${row.opAuto?(currentLang==='es'?'Auto desde Measurement Setup (edita para override)':'Auto from Measurement Setup (edit to override)'):(currentLang==='es'?'Override manual (Relink para regresar a auto)':'Manual override (Relink to go auto)')}"></td>

        <td>${inp(clamp(num(row.operators,1),0,99),'slim','Max 99')}</td>
        <td>${inp(clamp(num(row.shifts,1),1,3),'slim','1..3')}</td>

        <td>${inp(clamp(num(row.hours,8),1,24),'slim', row.hoursAuto?'Auto':'Manual')}</td>
        <td>${inp(clamp(num(row.machines,1),1,99),'slim','Max 99')}</td>
        <td>${inp(clamp(num(row.contractPcd,0),0,99999),'','Max 99999')}</td>

        <td>${formatUnits(gross)}</td>
        <td>${formatUnits(lunch)}</td>

        <td>${inp(clamp(num(row.changeoverMin,0),0,999),'slim','Max 999')}</td>
        <td>${inp(clamp(num(row.cleanMin,0),0,999),'slim','Max 999')}</td>
        <td>${inp(clamp(num(row.maintMin,0),0,999),'slim','Max 999')}</td>
        <td>${inp(clamp(num(row.otherMin,0),0,999),'slim','Max 999')}</td>

        <td>${inp(clamp(num(row.sharedMin,0),0,999),'slim','Subtracts from net')}</td>

        <td>${inp(clamp(num(row.udtValue,0),0,999),'slim','Max 999')}</td>
        <td>
          <select class="wb-sel">
            <option value="min_day" ${row.udtUnit==='min_day'?'selected':''}>${currentLang==='es'?'min/día':'min/day'}</option>
            <option value="sec_hour" ${row.udtUnit==='sec_hour'?'selected':''}>${currentLang==='es'?'seg/h':'sec/hr'}</option>
          </select>
        </td>

        <td>${formatUnits(net)}</td>

        <td>${inp(clamp(num(row.scrapPct,0),0,100),'slim','0..100')}</td>
        <td>${isFinite(yPct)?yPct.toFixed(1)+'%':'-'}</td>

        <td>${inp(clamp(num(row.oeeA,100),0,100),'slim','0..100')}</td>
        <td>${inp(clamp(num(row.oeeP,100),0,100),'slim','0..100')}</td>
        <td>${inp(clamp(num(row.oeeQ,100),0,100),'slim','0..100')}</td>
        <td>${isFinite(oeePct)?oeePct.toFixed(1)+'%':'-'}</td>

        <td title="${ct.source}">${isFinite(ctCur)?ctCur.toFixed(1):`<span class="wb-pill">${currentLang==='es'?'captura CT':'enter CT'}</span>`}</td>
        <td title="${ct.source}">${isFinite(ctWst)?ctWst.toFixed(1):'-'}</td>
        <td title="${ct.source}">${isFinite(ctPot)?ctPot.toFixed(1):'-'}</td>

        <td>${isFinite(ctCurOee)?ctCurOee.toFixed(1):'-'}</td>

        <td>${cap100Cur?formatUnits(cap100Cur):'-'}</td>
        <td>${capOeeCur?formatUnits(capOeeCur):'-'}</td>

        <td>${isFinite(vs)?`<span class="badge ${vs<85?'badge-bad':(vs<100?'badge-warn':'badge-good')}">${vs.toFixed(0)}%</span>`:'-'}</td>
        <td>${isFinite(inputReq)?formatUnits(inputReq):'-'}</td>

        <td style="text-align:left">
          <button class="btn-relink" data-relink="${row.id}">${currentLang==='es'?'Relink':'Relink'}</button>
          <button class="btn-del" data-wbdel="${row.id}">${currentLang==='es'?'Borrar':'Delete'}</button>
        </td>
      `;

      wbBody.appendChild(tr);

      // Map controls by column (hard-indexed to match your table)
      const cells = tr.querySelectorAll('td');
      const getInputAt  = (i)=>cells[i]?.querySelector('input');
      const getSelectAt = (i)=>cells[i]?.querySelector('select');

      const IDX = {
        seq:0, enabled:1, op:2,
        operators:3, shifts:4, hours:5, machines:6, contract:7,
        changeover:10, clean:11, maint:12, other:13,
        shared:14,
        udtVal:15, udtUnit:16,
        scrap:18,
        oeeA:20, oeeP:21, oeeQ:22
      };

      const seqInp       = getInputAt(IDX.seq);
      const enChk        = cells[IDX.enabled].querySelector('input[type="checkbox"]');
      const opInp        = getInputAt(IDX.op);
      const operatorsInp = getInputAt(IDX.operators);
      const shiftsInp    = getInputAt(IDX.shifts);
      const hoursInp     = getInputAt(IDX.hours);
      const machinesInp  = getInputAt(IDX.machines);
      const contractInp  = getInputAt(IDX.contract);

      const changeInp    = getInputAt(IDX.changeover);
      const cleanInp     = getInputAt(IDX.clean);
      const maintInp     = getInputAt(IDX.maint);
      const otherInp     = getInputAt(IDX.other);

      const sharedInp    = getInputAt(IDX.shared);

      const udtValInp    = getInputAt(IDX.udtVal);
      const udtUnitSel   = getSelectAt(IDX.udtUnit);

      const scrapInp     = getInputAt(IDX.scrap);

      const oeeAInp      = getInputAt(IDX.oeeA);
      const oeePInp      = getInputAt(IDX.oeeP);
      const oeeQInp      = getInputAt(IDX.oeeQ);

      const onChange = ()=>{
        row.seq     = clamp(num(seqInp.value,0),0,99);
        row.enabled = !!enChk.checked;

        const opNew = (opInp.value||'').trim();
        if(opNew !== row.operation){
          row.operation = opNew;
          row.opAuto = false;
        }

        row.operators = clamp(num(operatorsInp.value,0),0,99);
        row.shifts    = clamp(num(shiftsInp.value,1),1,3);

        const hNew = clamp(num(hoursInp.value,8),1,24);
        if(hNew !== row.hours){
          row.hours = hNew;
          row.hoursAuto = false;
        }else{
          row.hours = hNew;
        }

        row.machines = clamp(num(machinesInp.value,1),1,99);

        const cNew = clamp(num(contractInp.value,0),0,99999);
        if(cNew !== row.contractPcd){
          row.contractPcd = cNew;
          row.contractAuto = false;
        }else{
          row.contractPcd = cNew;
        }

        row.changeoverMin = clamp(num(changeInp.value,0),0,999);
        row.cleanMin      = clamp(num(cleanInp.value,0),0,999);
        row.maintMin      = clamp(num(maintInp.value,0),0,999);
        row.otherMin      = clamp(num(otherInp.value,0),0,999);

        row.sharedMin     = clamp(num(sharedInp.value,0),0,999);

        row.udtValue      = clamp(num(udtValInp.value,0),0,999);
        row.udtUnit       = udtUnitSel.value;

        row.scrapPct      = clamp(num(scrapInp.value,0),0,100);

        row.oeeA          = clamp(num(oeeAInp.value,100),0,100);
        row.oeeP          = clamp(num(oeePInp.value,100),0,100);

        const qNew = clamp(num(oeeQInp.value,100),0,100);
        if(qNew !== row.oeeQ){
          row.oeeQ = qNew;
          row.qAuto = false;
        }else{
          row.oeeQ = qNew;
        }

        saveWB();
        renderAll();
      };

      [seqInp, enChk, opInp, operatorsInp, shiftsInp, hoursInp, machinesInp, contractInp,
       changeInp, cleanInp, maintInp, otherInp, sharedInp,
       udtValInp, udtUnitSel, scrapInp, oeeAInp, oeePInp, oeeQInp
      ].forEach(el=> el && el.addEventListener('change', onChange));
    });

    wbOperatorsSum.textContent = String(Math.round(opsSum));

    // row delete
    wbBody.querySelectorAll('[data-wbdel]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-wbdel');
        wbRows = wbRows.filter(r=>r.id!==id);
        saveWB();
        renderAll();
      });
    });

    // relink
    wbBody.querySelectorAll('[data-relink]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-relink');
        const row = wbRows.find(r=>r.id===id);
        if(!row) return;

        row.opAuto       = true;
        row.hoursAuto    = true;
        row.contractAuto = true;
        row.qAuto        = true;

        applyGlobalToRow(row);
        saveWB();
        renderAll();
      });
    });

    computeAndRenderConstraint();
  }

  // ============================================================
  // Constraint Engine: picks Primary + Next
  // ============================================================
  function computeAndRenderConstraint(){
    const rows = wbRows.filter(r=>r.enabled);

    if(!rows.length){
      wbConstraint.textContent = currentLang==='es' ? 'WB vacío' : 'WB empty';
      wbNextConstraint.textContent = '—';
      wbConstraintNote.textContent = currentLang==='es'
        ? 'Agrega operaciones para identificar el proceso más débil.'
        : 'Add operations to identify the weakest process.';
      return;
    }

    const scored = rows.map(r=>{
      const net = computeNetMinutes(r);
      const oee = computeOeePct(r);
      const ct  = getCtTriple(r);

      const capOeeCur = computeCapacityPerDay(net, ct.cur) * oee;
      const contract  = clamp(num(r.contractPcd,0),0,99999);
      const vs        = (contract>0) ? (capOeeCur/contract*100) : NaN;

      return { r, capOeeCur, contract, vs };
    }).filter(x => isFinite(x.capOeeCur) && x.capOeeCur>=0);

    if(!scored.length){
      wbConstraint.textContent = currentLang==='es' ? 'Sin CT' : 'No CT';
      wbNextConstraint.textContent = '—';
      wbConstraintNote.textContent = currentLang==='es'
        ? 'No hay CT (medición o manual). Captura laps o define CT manual.'
        : 'No CT (study or manual). Capture laps or set manual CT.';
      return;
    }

    const anyContract = scored.some(x=>x.contract>0);
    const anyFail     = scored.some(x=>x.contract>0 && x.vs<100);

    let primary=null, secondary=null, note='';

    if(anyContract && anyFail){
      // worst % vs contract
      scored.sort((a,b)=>{
        const av = isFinite(a.vs)?a.vs:1e18;
        const bv = isFinite(b.vs)?b.vs:1e18;
        return av-bv;
      });
      primary   = scored[0];
      secondary = scored[1] || null;
      note = currentLang==='es'
        ? 'Restricción (vs contrato): proceso con menor % vs contrato.'
        : 'Constraint (vs contract): process with the lowest % vs contract.';
      wbConstraint.className = 'badge badge-bad';
      wbNextConstraint.className = 'badge badge-warn';
    }else{
      // lowest output
      scored.sort((a,b)=>a.capOeeCur-b.capOeeCur);
      primary   = scored[0];
      secondary = scored[1] || null;
      note = currentLang==='es'
        ? 'Proceso con menor salida (todos cumplen contrato o no hay contrato por operación).'
        : 'Lowest output process (all meet contract or no per-operation contract).';
      wbConstraint.className = 'badge badge-bad';
      wbNextConstraint.className = 'badge badge-warn';
    }

    const pTxt = primary
      ? `${primary.r.operation || '(no name)'} · ${formatUnits(primary.capOeeCur)}/${currentLang==='es'?'día':'day'}${(primary.contract>0 && isFinite(primary.vs))?` · ${primary.vs.toFixed(0)}%`:''}`
      : '—';

    const sTxt = secondary
      ? `${secondary.r.operation || '(no name)'} · ${formatUnits(secondary.capOeeCur)}/${currentLang==='es'?'día':'day'}${(secondary.contract>0 && isFinite(secondary.vs))?` · ${secondary.vs.toFixed(0)}%`:''}`
      : '—';

    wbConstraint.textContent = pTxt;
    wbNextConstraint.textContent = sTxt;
    wbConstraintNote.textContent = note;
  }

  // ============================================================
  // WB – Buttons
  // ============================================================
  btnWbAdd.addEventListener('click', ()=>{
    const r = defaultWbRow();
    const maxSeq = wbRows.reduce((m,x)=>Math.max(m, num(x.seq,0)), 0);
    r.seq = clamp((maxSeq||0)+10, 0, 99);

    r.operation = (processName.value||'').trim() || '';
    r.opAuto = true;

    r.hours = clamp(num(hoursPerDay.value,8),1,24);
    r.hoursAuto = true;

    r.contractPcd = clamp(num(contractPcd.value,0),0,99999);
    r.contractAuto = true;

    r.oeeQ = clamp(num(efficiency.value,100),0,100);
    r.qAuto = true;

    wbRows.push(r);
    saveWB();
    renderAll();

    setTimeout(()=>{
      const last = wbBody.querySelector('tr:last-child td:nth-child(3) input');
      if(last) last.focus();
    }, 50);
  });

  btnWbClear.addEventListener('click', ()=>{
    const ok = confirm(currentLang==='es'
      ? '¿Borrar WB completo? (no borra laps)'
      : 'Clear WB completely? (does not delete laps)'
    );
    if(!ok) return;
    wbRows = [];
    saveWB();
    renderAll();
  });
  // ==========================
  // WB – Capacity Planner
  // ==========================
  function defaultWbRow(){
    return {
      id: 'wb_' + Math.random().toString(36).slice(2,9),
      seq: 10,
      enabled: true,

      operation: '',
      opAuto: true,

      operators: 1,
      shifts: 1,
      hours: clamp(num(hoursPerDay.value,8), 1, 24),
      hoursAuto: true,

      machines: 1,
      contractPcd: clamp(num(contractPcd.value,0), 0, 99999),
      contractAuto: true,

      changeoverMin: 0,
      cleanMin: 0,
      maintMin: 0,
      otherMin: 0,

      sharedMin: 0,

      udtValue: 0,
      udtUnit: 'min_day', // min_day | sec_hour

      scrapPct: 0,

      oeeA: 100,
      oeeP: 100,
      oeeQ: clamp(num(efficiency.value,100),0,100),
      qAuto: true,

      ctCurManual: null,
      ctWstManual: null,
      ctPotManual: null
    };
  }

  function applyGlobalToRow(row){
    const gOp = (processName.value||'').trim();
    const gH  = clamp(num(hoursPerDay.value,8),1,24);
    const gC  = clamp(num(contractPcd.value,0),0,99999);
    const gQ  = clamp(num(efficiency.value,100),0,100);

    if(row.opAuto && gOp) row.operation = gOp;
    if(row.hoursAuto) row.hours = gH;
    if(row.contractAuto) row.contractPcd = gC;
    if(row.qAuto) row.oeeQ = gQ;
  }

  function ensureWbRowForOperation(op){
    const name = (op||'').trim();
    if(!name) return;
    let row = wbRows.find(r => (r.operation||'').trim() === name);
    if(!row){
      row = defaultWbRow();
      const maxSeq = wbRows.reduce((m,x)=>Math.max(m, num(x.seq,0)), 0);
      row.seq = clamp(maxSeq + 10, 0, 99);
      row.operation = name;
      row.opAuto = true;
      wbRows.push(row);
      saveWB();
    }
  }

  function lunchMinutesPerShift(hours){
    if(hours<=6) return 15;
    if(hours<=8) return 30;
    if(hours<=10) return 45;
    return 60;
  }

  function computeGrossMinutes(row){
    const shifts = clamp(num(row.shifts,1),1,3);
    const hours  = clamp(num(row.hours,8),1,24);
    const machines = clamp(num(row.machines,1),1,99);
    return hours*60*shifts*machines;
  }
  function computeLunchMinutes(row){
    const shifts = clamp(num(row.shifts,1),1,3);
    const hours  = clamp(num(row.hours,8),1,24);
    return lunchMinutesPerShift(hours)*shifts;
  }
  function computeUdtMinutes(row){
    const shifts = clamp(num(row.shifts,1),1,3);
    const hours  = clamp(num(row.hours,8),1,24);
    const v = clamp(num(row.udtValue,0),0,999);
    if(row.udtUnit==='sec_hour'){
      const totalSeconds = v * (hours*shifts);
      return totalSeconds/60;
    }
    return v; // min/day
  }
  function computeNetMinutes(row){
    const gross = computeGrossMinutes(row);
    const lunch = computeLunchMinutes(row);
    const changeover = clamp(num(row.changeoverMin,0),0,999);
    const clean     = clamp(num(row.cleanMin,0),0,999);
    const maint     = clamp(num(row.maintMin,0),0,999);
    const other     = clamp(num(row.otherMin,0),0,999);
    const shared    = clamp(num(row.sharedMin,0),0,999);
    const udt       = computeUdtMinutes(row);
    return Math.max(0, gross - lunch - changeover - clean - maint - other - shared - udt);
  }

  function computeOeePct(row){
    const a = clamp(num(row.oeeA,100),0,100)/100;
    const p = clamp(num(row.oeeP,100),0,100)/100;
    const q = clamp(num(row.oeeQ,100),0,100)/100;
    return clamp(a*p*q,0,1);
  }
  function computeScrapYield(row){
    const scrap = clamp(num(row.scrapPct,0),0,100)/100;
    return (1 - scrap);
  }

  function getStudyStatsForOperation(opName){
    const groups = buildGroups();
    let best = null;
    for(const [k, arr] of groups.entries()){
      const [proc, mode] = k.split('||');
      if((proc||'').trim() === (opName||'').trim()){
        const st = computeGroupStats(arr);
        if(st){
          if(!best) best={st,mode};
          else if(best.mode!=='CT' && mode==='CT') best={st,mode};
          else if(st.n>best.st.n) best={st,mode};
        }
      }
    }
    return best;
  }

  function getCtTriple(row){
    const study = getStudyStatsForOperation(row.operation);
    if(study && study.st){
      const st = study.st;
      return { cur: st.md, wst: st.p90, pot: st.p10, source: `study (${study.mode}, N=${st.n})` };
    }
    const cur = (row.ctCurManual!=null) ? num(row.ctCurManual,NaN) : NaN;
    const wst = (row.ctWstManual!=null) ? num(row.ctWstManual,NaN) : NaN;
    const pot = (row.ctPotManual!=null) ? num(row.ctPotManual,NaN) : NaN;
    return { cur:isFinite(cur)?cur:NaN, wst:isFinite(wst)?wst:NaN, pot:isFinite(pot)?pot:NaN, source:'manual' };
  }

  function computeCapacityPerDay(netMinutes, ctSeconds){
    if(!isFinite(netMinutes) || netMinutes<=0) return 0;
    if(!isFinite(ctSeconds) || ctSeconds<=0) return 0;
    return (netMinutes*60)/ctSeconds;
  }

  function renderWB(){
    wbRows.forEach(applyGlobalToRow);
    wbRows.sort((a,b)=>{
      const sa=num(a.seq,0), sb=num(b.seq,0);
      if(sa!==sb) return sa-sb;
      return (a.operation||'').localeCompare(b.operation||'');
    });

    wbBody.innerHTML = '';
    let opsSum = 0;

    wbRows.forEach(row=>{
      opsSum += clamp(num(row.operators,0),0,99);

      const gross = computeGrossMinutes(row);
      const lunch = computeLunchMinutes(row);
      const net   = computeNetMinutes(row);

      const oee = computeOeePct(row);
      const oeePct = oee*100;

      const y = computeScrapYield(row);
      const yPct = y*100;

      const ct = getCtTriple(row);
      const ctCur = ct.cur, ctWst = ct.wst, ctPot = ct.pot;

      const ctCurOee = (isFinite(ctCur) && oee>0) ? (ctCur / oee) : NaN;

      const cap100Cur = computeCapacityPerDay(net, ctCur);
      const capOeeCur = cap100Cur * oee;

      const contract = clamp(num(row.contractPcd,0),0,99999);
      const vs = (contract>0) ? (capOeeCur/contract*100) : NaN;
      const inputReq = (contract>0 && y>0) ? (contract / y) : NaN;

      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td><input class="wb-inp slim" value="${clamp(num(row.seq,0),0,99)}" title="0..99"></td>
        <td style="text-align:center"><input type="checkbox" class="wb-chk" ${row.enabled?'checked':''}></td>

        <td><input class="wb-inp wide" value="${escAttr(row.operation||'')}" placeholder="${currentLang==='es'?'p. ej. Op 30-1':'e.g. Op 30-1'}"
          title="${row.opAuto?(currentLang==='es'?'Auto (edita para override)':'Auto (edit to override)'):(currentLang==='es'?'Override manual (Relink para auto)':'Manual override (Relink to auto)')}"></td>

        <td><input class="wb-inp slim" value="${clamp(num(row.operators,1),0,99)}"></td>
        <td><input class="wb-inp slim" value="${clamp(num(row.shifts,1),1,3)}"></td>

        <td><input class="wb-inp slim" value="${clamp(num(row.hours,8),1,24)}" title="${row.hoursAuto?'Auto':'Manual'}"></td>
        <td><input class="wb-inp slim" value="${clamp(num(row.machines,1),1,99)}"></td>
        <td><input class="wb-inp" value="${clamp(num(row.contractPcd,0),0,99999)}"></td>

        <td>${formatUnits(gross)}</td>
        <td>${formatUnits(lunch)}</td>

        <td><input class="wb-inp slim" value="${clamp(num(row.changeoverMin,0),0,999)}"></td>
        <td><input class="wb-inp slim" value="${clamp(num(row.cleanMin,0),0,999)}"></td>
        <td><input class="wb-inp slim" value="${clamp(num(row.maintMin,0),0,999)}"></td>
        <td><input class="wb-inp slim" value="${clamp(num(row.otherMin,0),0,999)}"></td>

        <td><input class="wb-inp slim" value="${clamp(num(row.sharedMin,0),0,999)}"></td>

        <td><input class="wb-inp slim" value="${clamp(num(row.udtValue,0),0,999)}"></td>
        <td>
          <select class="wb-sel">
            <option value="min_day" ${row.udtUnit==='min_day'?'selected':''}>${currentLang==='es'?'min/día':'min/day'}</option>
            <option value="sec_hour" ${row.udtUnit==='sec_hour'?'selected':''}>${currentLang==='es'?'seg/h':'sec/hr'}</option>
          </select>
        </td>

        <td>${formatUnits(net)}</td>

        <td><input class="wb-inp slim" value="${clamp(num(row.scrapPct,0),0,100)}"></td>
        <td>${isFinite(yPct)?yPct.toFixed(1)+'%':'-'}</td>

        <td><input class="wb-inp slim" value="${clamp(num(row.oeeA,100),0,100)}"></td>
        <td><input class="wb-inp slim" value="${clamp(num(row.oeeP,100),0,100)}"></td>
        <td><input class="wb-inp slim" value="${clamp(num(row.oeeQ,100),0,100)}"></td>
        <td>${isFinite(oeePct)?oeePct.toFixed(1)+'%':'-'}</td>

        <td title="${escAttr(ct.source)}">${isFinite(ctCur)?ctCur.toFixed(1):`<span class="wb-pill">${currentLang==='es'?'captura CT':'enter CT'}</span>`}</td>
        <td title="${escAttr(ct.source)}">${isFinite(ctWst)?ctWst.toFixed(1):'-'}</td>
        <td title="${escAttr(ct.source)}">${isFinite(ctPot)?ctPot.toFixed(1):'-'}</td>

        <td>${isFinite(ctCurOee)?ctCurOee.toFixed(1):'-'}</td>

        <td>${isFinite(cap100Cur)?formatUnits(cap100Cur):'-'}</td>
        <td>${isFinite(capOeeCur)?formatUnits(capOeeCur):'-'}</td>

        <td>${isFinite(vs)?`<span class="badge ${vs<85?'badge-bad':(vs<100?'badge-warn':'badge-good')}">${vs.toFixed(0)}%</span>`:'-'}</td>
        <td>${isFinite(inputReq)?formatUnits(inputReq):'-'}</td>

        <td style="text-align:left">
          <button class="btn-relink" data-relink="${row.id}">${currentLang==='es'?'Relink':'Relink'}</button>
          <button class="btn-del" data-wbdel="${row.id}">${currentLang==='es'?'Borrar':'Delete'}</button>
        </td>
      `;

      wbBody.appendChild(tr);

      const tds = tr.querySelectorAll('td');
      const seqInp = tds[0].querySelector('input');
      const enChk  = tds[1].querySelector('input[type="checkbox"]');
      const opInp  = tds[2].querySelector('input');

      const operatorsInp = tds[3].querySelector('input');
      const shiftsInp    = tds[4].querySelector('input');
      const hoursInp     = tds[5].querySelector('input');
      const machinesInp  = tds[6].querySelector('input');
      const contractInp  = tds[7].querySelector('input');

      const changeInp = tds[10].querySelector('input');
      const cleanInp  = tds[11].querySelector('input');
      const maintInp  = tds[12].querySelector('input');
      const otherInp  = tds[13].querySelector('input');

      const sharedInp = tds[14].querySelector('input');

      const udtValInp = tds[15].querySelector('input');
      const udtUnitSel= tds[16].querySelector('select');

      const scrapInp  = tds[18].querySelector('input');

      const oeeAInp = tds[20].querySelector('input');
      const oeePInp = tds[21].querySelector('input');
      const oeeQInp = tds[22].querySelector('input');

      const onChange = ()=>{
        row.seq = clamp(num(seqInp.value,0),0,99);
        row.enabled = !!enChk.checked;

        const opNew = (opInp.value||'').trim();
        if(opNew !== row.operation){
          row.operation = opNew;
          row.opAuto = false;
        }

        row.operators = clamp(num(operatorsInp.value,1),0,99);
        row.shifts    = clamp(num(shiftsInp.value,1),1,3);

        const hNew = clamp(num(hoursInp.value,8),1,24);
        if(hNew !== row.hours){
          row.hours = hNew;
          row.hoursAuto = false;
        }else{
          row.hours = hNew;
        }

        row.machines = clamp(num(machinesInp.value,1),1,99);

        const cNew = clamp(num(contractInp.value,0),0,99999);
        if(cNew !== row.contractPcd){
          row.contractPcd = cNew;
          row.contractAuto = false;
        }else{
          row.contractPcd = cNew;
        }

        row.changeoverMin = clamp(num(changeInp.value,0),0,999);
        row.cleanMin      = clamp(num(cleanInp.value,0),0,999);
        row.maintMin      = clamp(num(maintInp.value,0),0,999);
        row.otherMin      = clamp(num(otherInp.value,0),0,999);

        row.sharedMin = clamp(num(sharedInp.value,0),0,999);

        row.udtValue = clamp(num(udtValInp.value,0),0,999);
        row.udtUnit  = udtUnitSel.value;

        row.scrapPct = clamp(num(scrapInp.value,0),0,100);

        row.oeeA = clamp(num(oeeAInp.value,100),0,100);
        row.oeeP = clamp(num(oeePInp.value,100),0,100);

        const qNew = clamp(num(oeeQInp.value,100),0,100);
        if(qNew !== row.oeeQ){
          row.oeeQ = qNew;
          row.qAuto = false;
        }else{
          row.oeeQ = qNew;
        }

        saveWB();
        renderAll();
      };

      [
        seqInp, enChk, opInp, operatorsInp, shiftsInp, hoursInp, machinesInp, contractInp,
        changeInp, cleanInp, maintInp, otherInp, sharedInp,
        udtValInp, udtUnitSel, scrapInp, oeeAInp, oeePInp, oeeQInp
      ].forEach(el=>el.addEventListener('change', onChange));
    });

    wbOperatorsSum.textContent = String(Math.round(opsSum));
    wbBody.querySelectorAll('[data-wbdel]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-wbdel');
        wbRows = wbRows.filter(r=>r.id!==id);
        saveWB();
        renderAll();
      });
    });

    wbBody.querySelectorAll('[data-relink]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-relink');
        const row = wbRows.find(r=>r.id===id);
        if(!row) return;
        row.opAuto=true; row.hoursAuto=true; row.contractAuto=true; row.qAuto=true;
        applyGlobalToRow(row);
        saveWB();
        renderAll();
      });
    });

    computeAndRenderConstraint();
  }

  function computeAndRenderConstraint(){
    const rows = wbRows.filter(r=>r.enabled);
    if(!rows.length){
      wbConstraint.textContent = currentLang==='es' ? 'WB vacío' : 'WB empty';
      wbNextConstraint.textContent = '—';
      wbConstraintNote.textContent = currentLang==='es'
        ? 'Agrega operaciones para identificar el proceso más débil.'
        : 'Add operations to identify the weakest process.';
      return;
    }

    const scored = rows.map(r=>{
      const net = computeNetMinutes(r);
      const oee = computeOeePct(r);
      const ct  = getCtTriple(r);
      const capOeeCur = computeCapacityPerDay(net, ct.cur) * oee;
      const contract = clamp(num(r.contractPcd,0),0,99999);
      const vs = (contract>0) ? (capOeeCur/contract*100) : NaN;
      return { r, capOeeCur, contract, vs };
    }).filter(x => isFinite(x.capOeeCur) && x.capOeeCur>=0);

    if(!scored.length){
      wbConstraint.textContent = currentLang==='es' ? 'Sin CT' : 'No CT';
      wbNextConstraint.textContent = '—';
      wbConstraintNote.textContent = currentLang==='es'
        ? 'No hay CT (medición o manual). Captura laps o define CT manual.'
        : 'No CT (study or manual). Capture laps or set manual CT.';
      return;
    }

    const anyContract = scored.some(x=>x.contract>0);
    const anyFail = scored.some(x=>x.contract>0 && x.vs<100);

    let primary=null, secondary=null;
    let note='';

    if(anyContract && anyFail){
      scored.sort((a,b)=>{
        const av = isFinite(a.vs)?a.vs:1e18;
        const bv = isFinite(b.vs)?b.vs:1e18;
        return av-bv;
      });
      primary = scored[0];
      secondary = scored[1]||null;
      note = currentLang==='es'
        ? 'Restricción (vs contrato): menor % vs contrato.'
        : 'Constraint (vs contract): lowest % vs contract.';
    }else{
      scored.sort((a,b)=>a.capOeeCur-b.capOeeCur);
      primary = scored[0];
      secondary = scored[1]||null;
      note = currentLang==='es'
        ? 'Menor salida (todos cumplen contrato o no hay contrato por operación).'
        : 'Lowest output (all meet contract or no per-operation contract).';
    }

    const pTxt = primary
      ? `${primary.r.operation||'(no name)'} · ${formatUnits(primary.capOeeCur)}/${currentLang==='es'?'día':'day'}${(primary.contract>0&&isFinite(primary.vs))?` · ${primary.vs.toFixed(0)}%`:''}`
      : '—';
    const sTxt = secondary
      ? `${secondary.r.operation||'(no name)'} · ${formatUnits(secondary.capOeeCur)}/${currentLang==='es'?'día':'day'}${(secondary.contract>0&&isFinite(secondary.vs))?` · ${secondary.vs.toFixed(0)}%`:''}`
      : '—';

    wbConstraint.className = 'badge badge-bad';
    wbNextConstraint.className = 'badge badge-warn';

    wbConstraint.textContent = pTxt;
    wbNextConstraint.textContent = sTxt;
    wbConstraintNote.textContent = note;
  }

  // Buttons: WB Add / Clear
  btnWbAdd.addEventListener('click', ()=>{
    const r = defaultWbRow();
    const maxSeq = wbRows.reduce((m,x)=>Math.max(m, num(x.seq,0)), 0);
    r.seq = clamp(maxSeq + 10, 0, 99);

    r.operation = (processName.value||'').trim() || '';
    r.opAuto = true;

    wbRows.push(r);
    saveWB();
    renderAll();
    setTimeout(()=>{
      const last = wbBody.querySelector('tr:last-child td:nth-child(3) input');
      if(last) last.focus();
    }, 50);
  });

  btnWbClear.addEventListener('click', ()=>{
    const ok = confirm(currentLang==='es'
      ? '¿Borrar WB completo? (no borra laps)'
      : 'Clear WB completely? (does not delete laps)');
    if(!ok) return;
    wbRows = [];
    saveWB();
    renderAll();
  });

  // ======== PARTE 6/6 CONTINÚA DESDE AQUÍ ========
  // ==========================
  // Charts
  // ==========================
  function updateChartOptions(){
    const groups = buildGroups();
    const prev = chartProcessSelect.value;
    chartProcessSelect.innerHTML = '';

    if(!groups.size){
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = currentLang==='es' ? 'Sin procesos aún' : 'No process yet';
      chartProcessSelect.appendChild(opt);
      drawTimeSeries(null,null);
      drawHistogram(null,null);
      return;
    }

    let first = null;
    [...groups.keys()].forEach(key=>{
      if(!first) first = key;
      const [p,m] = key.split('||');
      const opt = document.createElement('option');
      opt.value = key;
      opt.textContent = `${p} (${m})`;
      chartProcessSelect.appendChild(opt);
    });

    chartProcessSelect.value = (prev && groups.has(prev)) ? prev : first;
    renderCharts();
  }

  function renderCharts(){
    const key = chartProcessSelect.value;
    const groups = buildGroups();
    if(!key || !groups.has(key)){
      drawTimeSeries(null,null);
      drawHistogram(null,null);
      return;
    }
    const arr = groups.get(key);
    const st  = computeGroupStats(arr);
    drawTimeSeries(arr, st);
    drawHistogram(arr, st);
  }

  function fitCanvas(canvas){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width  = Math.max(1, Math.floor(rect.width  * dpr));
    canvas.height = Math.max(1, Math.floor(rect.height * dpr));
    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }

  function drawTimeSeries(arr, st){
    fitCanvas(timeSeriesCanvas);
    const ctx = timeSeriesCanvas.getContext('2d');
    const w = timeSeriesCanvas.getBoundingClientRect().width;
    const h = timeSeriesCanvas.getBoundingClientRect().height;

    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = '#020b1a';
    ctx.fillRect(0,0,w,h);

    if(!arr || !arr.length || !st || st.n<3){
      ctx.fillStyle = '#607d8b';
      ctx.font = '12px system-ui';
      ctx.fillText(currentLang==='es'?'Se requieren al menos 3 muestras.':'Need at least 3 samples.',10,20);
      return;
    }

    const vals = st.sorted;
    let min = st.min, max = st.max;
    if(min===max){ min-=0.5; max+=0.5; }

    const padL=35, padR=8, padT=10, padB=18;
    const innerW=w-padL-padR, innerH=h-padT-padB;

    const yScale = v => padT + innerH*(1-(v-min)/(max-min));
    const xScale = i => vals.length===1 ? (padL+innerW/2) : (padL+innerW*(i/(vals.length-1)));

    // grid
    ctx.strokeStyle='rgba(255,255,255,0.08)';
    ctx.lineWidth=1;
    ctx.beginPath();
    for(let g=0; g<=4; g++){
      const y=padT+innerH*g/4;
      ctx.moveTo(padL,y); ctx.lineTo(w-padR,y);
    }
    ctx.stroke();

    // axis
    ctx.strokeStyle='rgba(255,255,255,0.4)';
    ctx.beginPath();
    ctx.moveTo(padL,padT); ctx.lineTo(padL,h-padB); ctx.lineTo(w-padR,h-padB);
    ctx.stroke();

    // y labels
    ctx.fillStyle='#90a4ae';
    ctx.font='10px system-ui';
    for(let g=0; g<=4; g++){
      const val=min+(max-min)*g/4;
      const y=padT+innerH*(1-g/4);
      ctx.fillText(val.toFixed(1),2,y+3);
    }

    // line
    ctx.strokeStyle='#29b6f6';
    ctx.lineWidth=2;
    ctx.beginPath();
    vals.forEach((v,i)=>{
      const x=xScale(i), y=yScale(v);
      if(i) ctx.lineTo(x,y); else ctx.moveTo(x,y);
    });
    ctx.stroke();

    // points
    ctx.fillStyle='#29b6f6';
    vals.forEach((v,i)=>{
      const x=xScale(i), y=yScale(v);
      ctx.beginPath(); ctx.arc(x,y,2.2,0,Math.PI*2); ctx.fill();
    });

    // mean / median / ±3σ
    ctx.setLineDash([4,3]);
    if(st.std>0){
      const ucl=st.mean+3*st.std;
      const lcl=st.mean-3*st.std;
      ctx.strokeStyle='rgba(255,82,82,0.9)';
      ctx.beginPath();
      ctx.moveTo(padL,yScale(ucl)); ctx.lineTo(w-padR,yScale(ucl));
      ctx.moveTo(padL,yScale(lcl)); ctx.lineTo(w-padR,yScale(lcl));
      ctx.stroke();
    }
    ctx.strokeStyle='rgba(255,255,255,0.6)';
    ctx.beginPath(); ctx.moveTo(padL,yScale(st.mean)); ctx.lineTo(w-padR,yScale(st.mean)); ctx.stroke();

    ctx.strokeStyle='rgba(0,230,118,0.9)';
    ctx.beginPath(); ctx.moveTo(padL,yScale(st.md)); ctx.lineTo(w-padR,yScale(st.md)); ctx.stroke();
    ctx.setLineDash([]);
  }

  function drawHistogram(arr, st){
    fitCanvas(histCanvas);
    const ctx = histCanvas.getContext('2d');
    const w = histCanvas.getBoundingClientRect().width;
    const h = histCanvas.getBoundingClientRect().height;

    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = '#020b1a';
    ctx.fillRect(0,0,w,h);

    if(!arr || !arr.length || !st || st.n<3){
      ctx.fillStyle = '#607d8b';
      ctx.font = '12px system-ui';
      ctx.fillText(currentLang==='es'?'Se requieren más muestras.':'Need more samples.',10,20);
      return;
    }

    let min = st.min, max = st.max;
    if(min===max){ min-=0.5; max+=0.5; }

    const padL=30, padR=8, padT=8, padB=20;
    const innerW=w-padL-padR, innerH=h-padT-padB;

    const binsCount = 8;
    const binSize = (max-min)/binsCount;
    const bins = new Array(binsCount).fill(0);

    st.sorted.forEach(v=>{
      let idx = Math.floor((v-min)/binSize);
      if(idx===binsCount) idx=binsCount-1;
      bins[idx]++;
    });
    const maxBin = Math.max(...bins);

    // axis
    ctx.strokeStyle='rgba(255,255,255,0.4)';
    ctx.beginPath();
    ctx.moveTo(padL,padT); ctx.lineTo(padL,h-padB); ctx.lineTo(w-padR,h-padB);
    ctx.stroke();

    // bars
    const barW = innerW/binsCount;
    ctx.fillStyle='#29b6f6';
    bins.forEach((c,i)=>{
      const x = padL+i*barW+1;
      const barH = maxBin ? innerH*(c/maxBin) : 0;
      const y = (h-padB)-barH;
      ctx.fillRect(x,y,barW-2,barH);
    });

    // median line
    const medX = padL + innerW*((st.md-min)/(max-min));
    ctx.strokeStyle='#00e676';
    ctx.beginPath(); ctx.moveTo(medX,padT); ctx.lineTo(medX,h-padB); ctx.stroke();

    // p10/p90
    const p10x = padL + innerW*((st.p10-min)/(max-min));
    const p90x = padL + innerW*((st.p90-min)/(max-min));
    ctx.strokeStyle='rgba(255,241,118,0.9)';
    ctx.beginPath();
    ctx.moveTo(p10x,padT); ctx.lineTo(p10x,h-padB);
    ctx.moveTo(p90x,padT); ctx.lineTo(p90x,h-padB);
    ctx.stroke();
  }

  // ==========================
  // Copy helpers
  // ==========================
  async function copyToClipboard(text){
    if(!text) return;
    try{
      await navigator.clipboard.writeText(text);
      alert(currentLang==='es'?'Copiado.':'Copied.');
    }catch(e){
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      try{
        document.execCommand('copy');
        alert(currentLang==='es'?'Copiado.':'Copied.');
      }catch(err){
        alert(currentLang==='es'?'No disponible el portapapeles.':'Clipboard not available.');
      }
      document.body.removeChild(ta);
    }
  }

  btnCopyAll.addEventListener('click', ()=>{
    if(!laps.length){
      alert(currentLang==='es'?'No hay datos.':'No data.');
      return;
    }
    const header = currentLang==='es'
      ? ['#','Proceso','Modo','Estatus','Nota','T1 (s)','T2 (s)','Total (s)']
      : ['#','Process','Mode','Status','Note','T1 (s)','T2 (s)','Total (s)'];

    const rows = laps.map((l,i)=>[
      i+1,
      l.process, l.mode,
      l.status||'',
      l.note||'',
      (isFinite(l.t1)?l.t1.toFixed(1):'0.0'),
      (isFinite(l.t2)?l.t2.toFixed(1):'0.0'),
      (isFinite(l.total)?l.total.toFixed(1):'0.0')
    ].join('\t'));

    copyToClipboard(header.join('\t')+'\n'+rows.join('\n'));
  });

  btnCopySummary.addEventListener('click', ()=>{
    const lines=[];
    lines.push(currentLang==='es'?'Resumen (WB + Stats)':'Summary (WB + Stats)');
    lines.push('—');
    lines.push((currentLang==='es'?'Restricción: ':'Constraint: ') + wbConstraint.textContent);
    lines.push((currentLang==='es'?'Siguiente: ':'Next: ') + wbNextConstraint.textContent);
    lines.push((currentLang==='es'?'Operadores total: ':'Operators total: ') + wbOperatorsSum.textContent);
    lines.push('—');
    lines.push(currentLang==='es'?'WB (por operación):':'WB (by operation):');

    const enabled = wbRows.filter(r=>r.enabled).slice().sort((a,b)=>num(a.seq,0)-num(b.seq,0));
    enabled.forEach(r=>{
      const net = computeNetMinutes(r);
      const oee = computeOeePct(r);
      const ct  = getCtTriple(r);
      const capOeeCur = computeCapacityPerDay(net, ct.cur) * oee;
      lines.push(`${r.seq} | ${r.operation||'(no name)'} | Cap@OEE ${formatUnits(capOeeCur)}/${currentLang==='es'?'día':'day'} | Contract ${formatUnits(num(r.contractPcd,0))} | Scrap ${(clamp(num(r.scrapPct,0),0,100)).toFixed(1)}%`);
    });

    lines.push('—');
    lines.push(currentLang==='es'?'Nota: usa "Copiar todo" para datos crudos.':'Note: use "Copy All" for raw data.');
    copyToClipboard(lines.join('\n'));
  });

  // ==========================
  // Render master
  // ==========================
  function renderAll(){
    renderRawTable();
    renderFocusTable();
    renderStatsDetail();
    updateChartOptions();
    updateSemaphores();
    renderWB();
    methodGuideText.textContent = buildMethodGuide();
  }

  // listeners
  chartProcessSelect.addEventListener('change', renderCharts);
  window.addEventListener('resize', renderCharts);

  [efficiency, contractPcd, hoursPerDay, daysPerWeek, capView, processName, mode].forEach(el=>{
    el.addEventListener('change', ()=>{
      wbRows.forEach(applyGlobalToRow);
      saveWB();
      renderAll();
    });
  });

  // init
  loadWB();
  updateClock();
  setLanguage(currentLang);

})(); 
</script>
</body>
</html>
