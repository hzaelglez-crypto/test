<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TaktLab ‚Äì Cycle Time & Capacity Analyzer</title>

<style>
:root{
  /* Fondo */
  --bg-main:#f3f5f7;
  --bg-card:#ffffff;
  --bg-card-soft:#fbfcfe;

  /* Colores */
  --accent-green:#18c97a;
  --accent-amber:#f2c14e;
  --accent-red:#ff3355;
  --accent-blue:#39bdf5;
  --accent-grey:#cfd8dc;

  --text-main:#0b1220;
  --text-soft:#3a4a66;
  --text-muted:#6b7a90;

  --border-soft:#d9e2ef;

  --btn-green:#18c97a;
  --btn-orange:#f2a93b;
  --btn-grey:#455a64;
  --btn-amber:#f2c14e;

  --badge-green:rgba(24,201,122,.14);
  --badge-red:rgba(255,51,85,.14);
  --badge-amber:rgba(242,193,78,.14);

  /* WB */
  --wb-on-w:56px;
  --wb-op-w:210px;
}

*{box-sizing:border-box;}

body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:var(--bg-main);
  color:var(--text-main);
}

.page{
  max-width:1100px;
  margin:0 auto;
  padding:6px 8px 16px;
}

/* ======================
   STICKY TIMER BAR
====================== */
.sticky-timer-bar{
  position:sticky;
  top:0;
  z-index:100;
  background:rgba(243,245,247,.92);
  backdrop-filter: blur(8px);
  padding:6px 0 8px;
  border-bottom:1px solid var(--border-soft);
}

.top-row{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:6px;
}

.logo-circle{
  width:38px;height:38px;border-radius:50%;
  border:2px solid rgba(11,18,32,.18);
  display:flex;align-items:center;justify-content:center;
  background:#fff;
}

.logo-gear{
  width:22px;height:22px;border-radius:50%;
  border:2px solid rgba(11,18,32,.18);
  position:relative;
}
.logo-gear::before{
  content:"";
  position:absolute;
  inset:4px;
  border-radius:50%;
  border:2px solid rgba(24,201,122,.95);
  border-right-color:transparent;
  border-bottom-color:transparent;
}
.logo-gear.spinning::before{
  animation:logo-spin 5s linear infinite;
}
@keyframes logo-spin{
  from{transform:rotate(0deg);}
  to{transform:rotate(360deg);}
}

.title-block{
  display:flex;
  flex-direction:column;
  gap:2px;
}
.title-main{
  font-size:1.2rem;
  font-weight:800;
  letter-spacing:.02em;
}
.title-sub{
  font-size:.72rem;
  color:var(--text-soft);
}

.lang-switch{
  margin-left:auto;
  display:flex;
  gap:6px;
}
.lang-btn{
  border-radius:999px;
  border:1px solid var(--border-soft);
  background:#fff;
  color:var(--text-soft);
  font-size:.7rem;
  padding:5px 10px;
  cursor:pointer;
}
.lang-btn.active{
  background:rgba(57,189,245,.95);
  color:#051018;
  font-weight:800;
}

/* ======================
   TIMER CARD
====================== */
.timer-card{
  background:var(--bg-card);
  border-radius:18px;
  border:1px solid var(--border-soft);
  padding:6px 10px 10px;
  box-shadow:0 10px 22px rgba(10,20,40,.08);
}

.timer-display{
  text-align:center;
  font-size:5rem;
  font-weight:650;
  letter-spacing:.08em;
  padding:10px 10px 4px;
}

.split-clocks{
  display:flex;
  gap:8px;
  justify-content:center;
  margin:2px 0 8px;
  flex-wrap:wrap;
}
.split-pill{
  display:flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(11,18,32,.10);
  background:rgba(11,18,32,.02);
  font-size:1rem;
  min-width:150px;
  justify-content:center;
}
.split-pill .tag{
  font-weight:900;
}
.split-pill.t1{ border-color: rgba(57,189,245,.28); }
.split-pill.t2{ border-color: rgba(242,193,78,.26); }

/* ======================
   BUTTONS
====================== */
.btn-row-main{
  display:flex;
  gap:10px;
}
.btn{
  border:none;
  border-radius:16px;
  padding:14px 16px;
  font-size:1rem;
  font-weight:900;
  cursor:pointer;
  flex:1;
  box-shadow:0 6px 14px rgba(10,20,40,.10);
}
.btn-start{ background:var(--btn-green); }
.btn-lap{ background:var(--btn-orange); }

.btn:disabled{
  opacity:.55;
  cursor:not-allowed;
}

/* ======================
   SECTIONS
====================== */
.section-card{
  background:var(--bg-card);
  border-radius:18px;
  border:2px solid var(--border-soft);
  padding:6px 8px 8px;
  margin-bottom:8px;
  box-shadow:0 10px 22px rgba(10,20,40,.06);
}

.section-card[data-accent="blue"]{ border-color: rgba(57,189,245,.55); }
.section-card[data-accent="green"]{ border-color: rgba(24,201,122,.45); }
.section-card[data-accent="amber"]{ border-color: rgba(242,193,78,.55); }
.section-card[data-accent="red"]{ border-color: rgba(255,51,85,.40); }

.section-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.section-title{
  font-size:.98rem;
  font-weight:900;
}

/* ======================
   TABLES
====================== */
table{
  width:100%;
  border-collapse:collapse;
  font-size:.72rem;
}
th,td{
  padding:3px 5px;
  border-bottom:1px solid rgba(11,18,32,.06);
  white-space:nowrap;
}
th{
  background:rgba(11,18,32,.02);
  font-weight:800;
  color:var(--text-soft);
}
tbody tr:nth-child(even){
  background:rgba(11,18,32,.015);
}

/* ======================
   RESPONSIVE
====================== */
@media (max-width:600px){
  .timer-display{ font-size:2.4rem; }
  .btn{ font-size:.9rem; }
}
</style>
</head>
<body>

<div class="sticky-timer-bar">
  <div class="page">
    <div class="top-row">
      <div class="logo-circle">
        <div id="logoGear" class="logo-gear"></div>
      </div>

      <div class="title-block">
        <div class="title-main">TaktLab</div>
        <div class="title-sub">Cycle Time & Capacity Analyzer</div>
      </div>

      <div class="lang-switch">
        <button class="lang-btn active" data-lang="es">ES</button>
        <button class="lang-btn" data-lang="en">EN</button>
      </div>
    </div>

    <div class="timer-card" id="timerCard">
      <div id="timerDisplay" class="timer-display">00:00.00</div>

      <div class="split-clocks">
        <div class="split-pill t1">
          <span class="tag">T1</span>
          <span id="t1Clock">00:00.00</span>
        </div>
        <div class="split-pill t2">
          <span class="tag">T2</span>
          <span id="t2Clock">00:00.00</span>
        </div>
      </div>

      <div class="btn-row-main">
        <button id="btnStart" class="btn btn-start">Inicio</button>
        <button id="btnLap" class="btn btn-lap">Vuelta</button>
      </div>
    </div>
  </div>
</div>

<div class="page">

  <!-- CONFIGURACI√ìN -->
  <div class="section-card" data-accent="blue">
    <div class="section-head">
      <div class="section-title">Configuraci√≥n de Medici√≥n</div>
      <button id="btnCopySetup" class="lang-btn">Copiar</button>
    </div>

    <table>
      <tr>
        <th>Proceso</th>
        <th>Modo</th>
        <th>Eficiencia %</th>
        <th>Contrato (pzs/d√≠a)</th>
        <th>Horas/d√≠a</th>
        <th>D√≠as/semana</th>
        <th>Vista</th>
      </tr>
      <tr>
        <td><input id="processInput" class="wb-inp" placeholder="Op 10"></td>
        <td>
          <select id="modeSelect" class="wb-sel">
            <option value="CT">CT</option>
            <option value="MLD">MLD</option>
          </select>
        </td>
        <td><input id="effInput" class="wb-inp" type="number" value="100"></td>
        <td><input id="pcdInput" class="wb-inp" type="number" value="0"></td>
        <td><input id="hInput" class="wb-inp" type="number" value="8"></td>
        <td><input id="dInput" class="wb-inp" type="number" value="5"></td>
        <td>
          <select id="capViewSel" class="wb-sel">
            <option value="hour">Hora</option>
            <option value="day">D√≠a</option>
            <option value="week">Semana</option>
          </select>
        </td>
      </tr>
    </table>
  </div>

  <!-- CONTROLES -->
  <div class="section-card" data-accent="green">
    <div class="section-head">
      <div class="section-title">Controles de Datos</div>
      <button id="btnCopyControls" class="lang-btn">Copiar</button>
    </div>

    <div class="btn-row-main">
      <button id="btnCopySum" class="btn">Copiar Resumen</button>
      <button id="btnCopyAll" class="btn">Copiar Todo</button>
      <button id="btnAddMan" class="btn">Agregar Manual</button>
      <button id="btnReset" class="btn">Reset</button>
    </div>
  </div>

  <!-- CONTRATO VS CAPACIDAD -->
  <div class="section-card" data-accent="amber">
    <div class="section-head">
      <div class="section-title">Contrato vs Capacidad</div>
      <button id="btnCopyContract" class="lang-btn">Copiar</button>
    </div>

    <div id="contractSumLine1"></div>
    <div id="contractSumLine2"></div>
    <div id="contractSumLine3"></div>
    <div id="contractSumLine4"></div>
  </div>

  <!-- SHARED CAPACITY -->
  <div class="section-card" data-accent="red">
    <div class="section-head">
      <div class="section-title">Shared Capacity</div>
      <div>
        <button id="btnScAddMachine" class="lang-btn">+ M√°quina</button>
        <button id="btnScClear" class="lang-btn">Borrar</button>
        <button id="btnCopyShared" class="lang-btn">Copiar</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>On</th>
          <th>Operaci√≥n</th>
          <th>Avail min/d√≠a</th>
          <th>Planned DT</th>
          <th>Unplanned DT</th>
          <th>D√≠as/sem</th>
          <th>Sem/a√±o</th>
          <th>Req</th>
          <th>Util %</th>
          <th>Status</th>
          <th>Sync WB</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="scBody"></tbody>
    </table>
  </div>

</div>

<!-- JS EN PARTE 3 -->
</body>
<script>
/* ============================
   ESTADO GLOBAL
============================ */
let running = false;
let startTime = 0;
let elapsed = 0;
let rafId = null;

let scMachines = [];
const SC_KEY = 'SC_STATE_V1';

/* ============================
   UTILIDADES
============================ */
const $ = id => document.getElementById(id);
const clamp = (n,min,max)=>Math.min(Math.max(n,min),max);

function saveSC(){
  localStorage.setItem(SC_KEY, JSON.stringify(scMachines));
}
function loadSC(){
  try{
    const raw = localStorage.getItem(SC_KEY);
    scMachines = raw ? JSON.parse(raw) : [];
  }catch(e){ scMachines=[]; }
}

/* ============================
   TIMER
============================ */
function format(ms){
  const t = ms/1000;
  const m = Math.floor(t/60);
  const s = (t%60).toFixed(2).padStart(5,'0');
  return `${String(m).padStart(2,'0')}:${s}`;
}

function tick(){
  elapsed = performance.now() - startTime;
  $('timerDisplay').textContent = format(elapsed);
  rafId = requestAnimationFrame(tick);
}

$('btnStart').onclick = ()=>{
  if(!running){
    running = true;
    startTime = performance.now() - elapsed;
    rafId = requestAnimationFrame(tick);
    $('btnStart').textContent = 'Pausa';
  }else{
    running = false;
    cancelAnimationFrame(rafId);
    $('btnStart').textContent = 'Inicio';
  }
};

/* ============================
   SHARED CAPACITY
============================ */
function defaultScMachine(){
  return {
    id: 'sc_' + Math.random().toString(36).slice(2,8),
    enabled: true,
    operation: '',
    availMinDay: 480,
    plannedDT: 0,
    unplannedDT: 0,
    daysPerWeek: 5,
    weeksPerYear: 47,
    syncToWB: false
  };
}

function scRender(){
  const body = $('scBody');
  body.innerHTML = '';

  scMachines.forEach(m=>{
    const tr = document.createElement('tr');

    function td(el){ const c=document.createElement('td'); c.appendChild(el); tr.appendChild(c); }
    function tdTxt(t){ const c=document.createElement('td'); c.textContent=t; tr.appendChild(c); }

    // On
    const chk = document.createElement('input');
    chk.type='checkbox';
    chk.checked=m.enabled;
    chk.onchange=()=>{ m.enabled=chk.checked; saveSC(); };
    td(chk);

    // Operation
    const op = document.createElement('input');
    op.className='wb-inp';
    op.value=m.operation;
    op.oninput=()=>{ m.operation=op.value; saveSC(); };
    td(op);

    // Avail
    const av = document.createElement('input');
    av.type='number'; av.value=m.availMinDay;
    av.oninput=()=>{ m.availMinDay=clamp(+av.value,0,1440); saveSC(); };
    td(av);

    // Planned
    const pdt = document.createElement('input');
    pdt.type='number'; pdt.value=m.plannedDT;
    pdt.oninput=()=>{ m.plannedDT=clamp(+pdt.value,0,1440); saveSC(); };
    td(pdt);

    // Unplanned
    const udt = document.createElement('input');
    udt.type='number'; udt.value=m.unplannedDT;
    udt.oninput=()=>{ m.unplannedDT=clamp(+udt.value,0,1440); saveSC(); };
    td(udt);

    // Days
    const d = document.createElement('input');
    d.type='number'; d.value=m.daysPerWeek;
    d.oninput=()=>{ m.daysPerWeek=clamp(+d.value,0,7); saveSC(); };
    td(d);

    // Weeks
    const w = document.createElement('input');
    w.type='number'; w.value=m.weeksPerYear;
    w.oninput=()=>{ m.weeksPerYear=clamp(+w.value,0,52); saveSC(); };
    td(w);

    // Req / Util / Status (placeholder)
    tdTxt('-');
    tdTxt('-');
    tdTxt('-');

    // Sync
    const sync = document.createElement('input');
    sync.type='checkbox';
    sync.checked=m.syncToWB;
    sync.onchange=()=>{ m.syncToWB=sync.checked; saveSC(); };
    td(sync);

    // Actions
    const del = document.createElement('button');
    del.textContent='Del';
    del.onclick=()=>{
      scMachines = scMachines.filter(x=>x.id!==m.id);
      saveSC(); scRender();
    };
    td(del);

    body.appendChild(tr);
  });
}

/* ============================
   BOTONES SHARED
============================ */
$('btnScAddMachine').onclick = ()=>{
  scMachines.push(defaultScMachine());
  saveSC(); scRender();
};

$('btnScClear').onclick = ()=>{
  if(!confirm('¬øBorrar TODO Shared Capacity?')) return;
  scMachines = [];
  saveSC(); scRender();
};

/* ============================
   INIT
============================ */
loadSC();
scRender();
</script>
<script>
/* ============================
   SHARED ‚Äì C√ÅLCULO REAL
============================ */

// üëâ helpers WB (si WB existe)
function findWbRowByOp(op){
  if(!window.wbRows || !Array.isArray(wbRows)) return null;
  const key = (op||'').trim().toLowerCase();
  return wbRows.find(r => (r.operation||'').trim().toLowerCase() === key) || null;
}

// üëâ c√°lculo por m√°quina compartida
function calcSharedMachine(m){
  // minutos netos disponibles por d√≠a
  const netAvail =
    clamp(+m.availMinDay||0,0,1440)
    - clamp(+m.plannedDT||0,0,1440)
    - clamp(+m.unplannedDT||0,0,1440);

  // si no hay subprocesos/partes ‚Üí 0
  const parts = Array.isArray(m.parts) ? m.parts : [];
  let reqMinDay = 0;

  parts.forEach(p=>{
    const ctSec = clamp(+p.ctSec||0,0,999);
    const scrap = clamp(+p.scrapPct||0,0,100)/100;
    const annual = clamp(+p.annualContract||0,0,1e9);
    const pcsPerCycle = clamp(+p.pcsPerCycle||1,1,99);
    const coMin = clamp(+p.changeoverMin||0,0,1440);
    const coFreqDays = clamp(+p.changeoverFreqDays||0,0,365);

    if(ctSec<=0 || annual<=0) return;

    // diario = anual / (semanas * d√≠as)
    const dailyParts =
      annual / Math.max((+m.weeksPerYear||47) * Math.max(+m.daysPerWeek||5,1),1);

    // minutos por CT
    const minCT =
      ((dailyParts / Math.max(1 - scrap,0.0001)) / pcsPerCycle)
      * (ctSec/60);

    // minutos por changeover (prorrateado)
    const minCO =
      (coFreqDays>0) ? (coMin / coFreqDays) : 0;

    reqMinDay += (minCT + minCO);
  });

  const utilPct = netAvail>0 ? (reqMinDay/netAvail*100) : 0;

  let badge = {cls:'badge-good', txt:'OK'};
  if(utilPct>=100){
    badge = {cls:'badge-bad', txt:'FALTA CAP'};
  }else if(utilPct>=90){
    badge = {cls:'badge-warn', txt:'JUSTO'};
  }

  // üëâ conclusi√≥n autom√°tica
  let conclusion = 'OK';
  if(utilPct>=100){
    conclusion = 'Agregar m√°quinas o bajar CT / CO';
  }else if(utilPct>=90){
    conclusion = 'Margen bajo ‚Äì vigilar variaci√≥n';
  }

  return {
    netAvail: Math.max(0,netAvail),
    reqMinDay,
    utilPct,
    badge,
    conclusion
  };
}

/* ============================
   SHARED ‚Äì RENDER EXTENDIDO
============================ */
const _scRenderBase = window.scRender;

window.scRender = function(){
  _scRenderBase();

  const body = document.getElementById('scBody');
  if(!body) return;

  [...body.querySelectorAll('tr')].forEach((tr, idx)=>{
    const m = scMachines[idx];
    if(!m) return;

    const r = calcSharedMachine(m);

    // columnas: Req / Util / Status
    tr.children[8].textContent = r.reqMinDay.toFixed(1);
    tr.children[9].textContent = r.utilPct.toFixed(1) + '%';
    tr.children[10].innerHTML =
      `<span class="badge ${r.badge.cls}">${r.badge.txt}</span>`;

    // üëâ SYNC a WB
    if(m.syncToWB && m.operation){
      const row = findWbRowByOp(m.operation);
      if(row){
        row.sharedMin = Math.round(r.reqMinDay);
        if(window.saveWB) saveWB();
      }
    }

    // tooltip simple (explica qu√© hacer)
    tr.title = r.conclusion;
  });
};

/* ============================
   RESUMEN GLOBAL (ARRIBA)
============================ */
function renderSharedSummary(){
  let worst = null;

  scMachines.forEach(m=>{
    const r = calcSharedMachine(m);
    if(!worst || r.utilPct > worst.utilPct){
      worst = {m,r};
    }
  });

  const box = document.getElementById('scSummary');
  if(!box) return;

  if(!worst){
    box.textContent = 'Sin m√°quinas compartidas';
    return;
  }

  box.innerHTML = `
    <strong>Shared Capacity ‚Äì Resumen</strong><br>
    Proceso: ${worst.m.operation || '‚Äî'}<br>
    Utilizaci√≥n: ${worst.r.utilPct.toFixed(1)}%<br>
    Acci√≥n: ${worst.r.conclusion}
  `;
}

// hook al render general
const _renderAllBase = window.renderAll;
window.renderAll = function(){
  _renderAllBase();
  renderSharedSummary();
};
</script>
